//
//  JobIntensionViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/10.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "JobIntensionViewController.h"
#import "MineInfoTableViewCell.h"
#import "YMTextView.h"
#import "SaveSuccessView.h"
#import "YMAddressPickView.h"
#import "YMDatePickerView.h"
#import "ChoseTradeViewController.h"
#import "CLAlertView.h"

@interface JobIntensionViewController ()<UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate,UITextViewDelegate>
@property (nonatomic, strong) UITableView *tableV;

@property (nonatomic, strong) UITextField *salaryTF;
@property (nonatomic, strong) UITextField *positionTF;
@property (nonatomic, strong) UITextField *markTF;
@property (nonatomic, strong) YMTextView *introTextV;

@property (nonatomic, strong) SaveSuccessView *saveSuccessV;
@end

@implementation JobIntensionViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    
    if (!self.dataSourceM) {//新增
        self.dataSourceM = [[ResumInitTCjResumeDto alloc]init];
    }
}

-(void)initUI{
    self.title = @"求职意向";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveBarItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    _tableV.rowHeight = Size(120/2);
}
#pragma mark - action
-(void)doSaveBarItem{
    if (self.salaryTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写期望薪资"];
        return;
    }
    if (self.dataSourceM.positionLocationId == 0) {
        [HUD showHUDError:nil title:@"请选择地点"];
        return;
    }
    if (self.positionTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写职位"];
        return;
    }
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.dataSourceM.ID ? NSStringFromInteger(self.dataSourceM.ID) : @"" forKey:@"id"];
    [dataDic setValue:self.dataSourceM.wantSalary forKey:@"wantSalary"];
    [dataDic setValue:NSStringFromInteger(self.dataSourceM.positionLocationId) forKey:@"positionLocationId"];
    [dataDic setValue:self.dataSourceM.workPosition forKey:@"workPosition"];
    [dataDic setValue:self.dataSourceM.workPosition forKey:@"workJob"];
    
    [dataDic setValue:NSStringFromInteger(self.dataSourceM.workClassId) forKey:@"workClassId"];
    [dataDic setValue:self.dataSourceM.personDesCard forKey:@"personDesCard"];
    [dataDic setValue:self.dataSourceM.selfEvaluate forKey:@"selfEvaluate"];
    [dataDic setValue:[[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.workTime/1000] stringWithFormat:@"yyyy-MM-dd"] forKey:@"workTime"];
    [dataDic setValue:self.dataSourceM.jobType forKey:@"jobType"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddOrEditResumeOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (dataDic) {
            //self.saveSuccessV.hidden = NO;
            if ([data valueForKey:@"data"]) {
                BLOCK_EXEC(self.addResumeBlock,[data valueForKey:@"data"]);
            }
            [self.navigationController popViewControllerAnimated:YES];
            
        }
    });
    
    
}

#pragma mark - tableview delegate
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return 3;
    }else if (section == 1){
        return 4;
    }
    return 0;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        CELL_DEFINE(MineInfoTableViewCell);
        cell.arrowImgV.hidden = YES;
        [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_offset(-Size(15));
            make.centerY.equalTo(cell.contentView);
        }];
        cell.textF.placeholder = @"请填写";
        cell.textF.enabled = YES;
        switch (indexPath.row) {
            case 0:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*期望薪资" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.text = self.dataSourceM.wantSalary;
                self.salaryTF = cell.textF;
                self.salaryTF.delegate = self;
                return cell;
            }
                break;
            case 1:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*地点" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请选择";
                cell.textF.enabled = NO;
                cell.textF.text = self.dataSourceM.positionLocationdes;
                return cell;
            }
                break;
            case 2:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*职位" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.text = self.dataSourceM.workPosition;
                self.positionTF = cell.textF;
                self.positionTF.delegate = self;
                return cell;
            }
                break;
            default:
                break;
        }
        
    }
    if (indexPath.section == 1) {
        CELL_DEFINE(MineInfoTableViewCell,
                    [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
                        make.right.mas_offset(-Size(15));
                        make.centerY.equalTo(cell.contentView);
                    }];
                    );
        cell.arrowImgV.hidden = YES;
        
        cell.textF.enabled = NO;
        cell.textF.placeholder = @"请选择";
        switch (indexPath.row) {
            case 0:
                cell.titleLab.text = @"到岗时间";
                if (self.dataSourceM.workTime == 0) {
                    cell.textF.text = @"";
                }else{
                    cell.textF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.workTime/1000] stringWithFormat:@"yyyy-MM-dd"];
                }
                
                break;
            case 1:
                cell.titleLab.text = @"工作类型";
                if ([self.dataSourceM.jobType isEqualToString:@"0"]) {
                    cell.textF.text = @"全职";
                }else if ([self.dataSourceM.jobType isEqualToString:@"1"]){
                    cell.textF.text = @"兼职";
                }
                
                break;
            case 2:
                cell.titleLab.text = @"行业";
                cell.textF.text = self.dataSourceM.workClassName;
                break;
            case 3:
                cell.textF.enabled = YES;
                cell.textF.placeholder = @"职业/技能/行业相关的词汇";
                cell.titleLab.text = @"个人标签";
                cell.textF.text = self.dataSourceM.personDesCard;
                self.markTF = cell.textF;
                self.markTF.delegate = self;
                break;
            default:
                break;
        }
        return cell;
    }
    
    
    CELL_DEFINE(UITableViewCell);
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    if (section == 1) {
        UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(120))];
        view.backgroundColor = RGBCOLOR(255, 255, 255);
        
        UILabel *itemLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
        itemLab.text = @"自我评价";
        [view addSubview:itemLab];
        [itemLab mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(Size(15));
            make.top.mas_offset(Size(20));
        }];
        
        YMTextView *introTextV = [YMTextView new];
        introTextV.textAlignment = NSTextAlignmentLeft;
        introTextV.placeholder = @"介绍自己，说明自己的最大优势，让企业看到你的闪光点";
        introTextV.layer.borderWidth = 0.5;
        introTextV.layer.borderColor = COLOR_RGB_line.CGColor;
        introTextV.textColor = COLOR_RGB_51;
        introTextV.font = FONT_SIZE_15;
        [view addSubview:introTextV];
        [introTextV mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(Size(15));
            make.right.mas_offset(-Size(15));
            make.top.equalTo(itemLab.mas_bottom).mas_offset(13);
            make.height.mas_equalTo(Size(120/2));
        }];
        self.introTextV = introTextV;
        self.introTextV.delegate = self;
        self.introTextV.text = self.dataSourceM.selfEvaluate;
        
        return view;
    }
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section == 1) {
        return Size(120);
    }
    return Size(10);
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [self.view endEditing:YES];
    MineInfoTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    
    if ([cell.titleLab.text isEqualToString:@"*地点"]) {
        YMAddressPickView *pick = [[YMAddressPickView alloc]initWithUI:0 y:kScreenHeight width:kScreenWidth height:250];
        pick.AdressBlock = ^(NSString *province, NSString *city, NSString *town, NSString *pid, NSString *cid, NSString *tid) {
            self.dataSourceM.positionLocationId = tid.integerValue;
            self.dataSourceM.positionLocationdes = [NSString stringWithFormat:@"%@%@%@",province,city,town];
            [self.tableV reloadData];
        };
        [pick showBottomView];
    }
    if ([cell.titleLab.text isEqualToString:@"到岗时间"]) {
        YMDatePickerView *pick = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-250 width:kScreenWidth height:250];
        pick.datePickerStyle = DateStyleShowYearMonthDay;
        //pick.endDay = @"2020-10-12";
        pick.beginDay = [NSDate dateTodayString:@"yyyy-MM-dd"];
        
        
        //[pick getNowDate:[NSDate date] animated:NO];
        pick.doneBlock = ^(NSDate *date) {
            self.dataSourceM.workTime = [date timeIntervalSince1970]*1000;
            [self.tableV reloadData];
        };
        [pick show];
    }
    if ([cell.titleLab.text isEqualToString:@"工作类型"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"工作类型";
        alert.titleArray = @[@"全职", @"兼职"];
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            
            self.dataSourceM.jobType = NSStringFromInteger(index);
            [self.tableV reloadData];
        };
        [alert show];
    }
    if ([cell.titleLab.text isEqualToString:@"行业"]) {
        ChoseTradeViewController *vc = [ChoseTradeViewController new];
        vc.multipleCount = 1;
        vc.tradeSelectedBlock = ^(NSDictionary * _Nonnull tradeDic) {
            NSArray *temp = tradeDic[@"tradeArr"];
            Children *c = temp[0];
            self.dataSourceM.workClassId = c.value;
            self.dataSourceM.workClassName = c.label;
            [self.tableV reloadData];
        };
        [self.navigationController pushViewController:vc animated:YES];
    }
}

#pragma mark - textField / textView delegate
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField == self.salaryTF) {
        self.dataSourceM.wantSalary = textField.text;
    }
    if (textField == self.positionTF) {
        self.dataSourceM.workPosition = textField.text;
    }
    if (textField == self.markTF) {
        self.dataSourceM.personDesCard = textField.text;
    }
}

-(void)textViewDidChange:(UITextView *)textView{
    self.dataSourceM.selfEvaluate = textView.text;
}

- (SaveSuccessView *)saveSuccessV{
    if (!_saveSuccessV) {
        _saveSuccessV = [[SaveSuccessView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, kScreenHeight)];
        [AppDelegateInstance.window addSubview:_saveSuccessV];
        _saveSuccessV.hidden = YES;
    }
    return _saveSuccessV;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
