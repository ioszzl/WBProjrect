//
//  PositionInfoEditViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/14.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "PositionInfoEditViewController.h"
#import "MineInfoTableViewCell.h"
#import "CLAlertView.h"
#import "ChoseTradeViewController.h"
#import "YMAddressPickView.h"
@interface PositionInfoEditViewController ()<UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate>
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) UIButton *depositBtn;

@property (nonatomic, strong) UITextField *companyNameTF;
@property (nonatomic, strong) UITextField *jobNameTF;
@property (nonatomic, strong) UITextField *departmentTF;
@property (nonatomic, strong) UITextField *companyAddressTF;
@property (nonatomic, strong) UITextField *postMoneyTF;

@end

@implementation PositionInfoEditViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    if (!self.postInitData.post) {
        self.postInitData.post = [[PositionInitPost alloc]init];
    }
    
    [self initUI];
    
}
-(void)initUI{
    self.title = @"岗位信息";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    _tableV.contentInset = UIEdgeInsetsMake(Size(10), 0, 0, 0);
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    _tableV.rowHeight = Size(120/2);
    
}
#pragma mark - action
-(void)doSaveItem{
    [self.view endEditing:YES];
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.postInitData.post.ID == 0 ? @"" : NSStringFromInteger(self.postInitData.post.ID) forKey:@"postId"];
    [dataDic setValue:self.postInitData.post.job_name forKey:@"jobName"];
    [dataDic setValue:self.postInitData.post.department forKey:@"department"];
    [dataDic setValue:NSStringFromInteger(self.postInitData.post.work_year) forKey:@"workYear"];
    [dataDic setValue:NSStringFromInteger(self.postInitData.post.industry_class_id) forKey:@"industryClassId"];
    [dataDic setValue:NSStringFromInteger(self.postInitData.post.work_address_region_id) forKey:@"workAddressRegionId"];
    [dataDic setValue:NSStringFromInteger(self.postInitData.post.education_level) forKey:@"educationLevel"];
    [dataDic setValue:self.postInitData.post.company_address forKey:@"companyAddress"];
    
    [dataDic setValue:NSStringFromInteger(self.postInitData.post.post_money_open) forKey:@"postMoneyOpen"];
    [dataDic setValue:NSStringFromInteger(self.postInitData.post.post_money) forKey:@"postMoney"];
    [dataDic setValue:@"1" forKey:@"status"];//发布状态(0.招聘中 1.未发布 2.已暂停)(必)
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddPostOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            if (code == 5000) {//认证通过之后未交入驻押金前为试用期,试用期只能发布3个岗位,另一种情况为非试用期,但入驻押金少于1000,同样不能发布职位,会返回5000,这时,请跳转充值页面
                [HUD showHUDError:nil title:data[@"data"]];
                return ;
            }
            [HUD showHUDError:nil title:@"已保存"];
            BLOCK_EXEC(self.addPositionBlock,data[@"data"]);
            [self.navigationController popViewControllerAnimated:YES];
        }
    });
}
-(void)doDepositBtn:(UIButton *)btn{
    btn.selected = !btn.selected;
    self.postInitData.post.post_money_open = btn.selected ? 1 : 0;
    [self.tableV reloadData];
}
#pragma mark - tableview delegate
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 1) {
        if (self.postInitData.post.post_money_open == 1) {
            return 6;
        }else{
            return 5;
        }
    }
    return 4;
}

-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        CELL_DEFINE(MineInfoTableViewCell);
        cell.arrowImgV.hidden = YES;
        cell.line.hidden = NO;
        
        [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_offset(-Size(15));
            make.centerY.equalTo(cell.contentView);
            make.left.equalTo(cell.titleLab.mas_right);
        }];
        cell.textF.adjustsFontSizeToFitWidth = YES;
        cell.textF.minimumFontSize = Size(5);
        cell.textF.enabled = YES;
        switch (indexPath.row) {
            case 0:
                cell.titleLab.text = @"公司名称";
                cell.textF.placeholder = @"请填写";
                cell.textF.enabled = NO;
                cell.textF.text = self.postInitData.companyName;
                self.companyNameTF = cell.textF;
                self.companyNameTF.delegate = self;
                break;
            case 1:
                cell.titleLab.text = @"岗位名称";
                cell.textF.placeholder = @"请填写";
                cell.textF.text = self.postInitData.post.job_name;
                self.jobNameTF = cell.textF;
                self.jobNameTF.delegate = self;
                break;
            case 2:
                cell.titleLab.text = @"部门名称";
                cell.textF.placeholder = @"请填写";
                cell.textF.text = self.postInitData.post.department;
                self.departmentTF = cell.textF;
                self.departmentTF.delegate = self;
                break;
            case 3:
                cell.titleLab.text = @"经验要求";
                cell.textF.placeholder = @"请选择";
                cell.textF.text = [AppDelegateInstance companyWorkYearNameWithID:self.postInitData.post.work_year];
                cell.textF.enabled = NO;
                break;
            default:
                break;
        }
        return cell;
    }
    if (indexPath.section == 1) {
        CELL_DEFINE(MineInfoTableViewCell);
        cell.arrowImgV.hidden = YES;
        cell.line.hidden = NO;
        [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_offset(-Size(15));
            make.centerY.equalTo(cell.contentView);
            make.left.equalTo(cell.titleLab.mas_right);
        }];
        cell.textF.adjustsFontSizeToFitWidth = YES;
        cell.textF.minimumFontSize = Size(5);
        cell.textF.enabled = NO;
        switch (indexPath.row) {
            case 0:
                cell.titleLab.text = @"行业类别";
                cell.textF.placeholder = @"请选择";
                cell.textF.text = self.postInitData.post.industry_class;
                break;
            case 1:
                cell.titleLab.text = @"学历要求";
                cell.textF.placeholder = @"请选择";
                cell.textF.text = [AppDelegateInstance educationNameWithID:self.postInitData.post.education_level];
                break;
            case 2:
                cell.titleLab.text = @"就职区域";
                cell.textF.placeholder = @"请选择";
                cell.textF.text = self.postInitData.post.work_address_region;
                break;
            case 3:{
                MineInfoTableViewCell *depositCell = [tableView dequeueReusableCellWithIdentifier:@"depositCell"];
                if (!depositCell) {
                    depositCell = [[MineInfoTableViewCell alloc]initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:@"depositCell"];
                    depositCell.arrowImgV.hidden = YES;
                    depositCell.textF.hidden = YES;
                    
                    self.depositBtn = [UIButton buttonWithType:UIButtonTypeCustom];
                    [self.depositBtn setImage:[UIImage imageNamed:@"guan"] forState:UIControlStateNormal];
                    [self.depositBtn setImage:[UIImage imageNamed:@"open1"] forState:UIControlStateSelected];
                    [depositCell.contentView addSubview:self.depositBtn];
                    [_depositBtn mas_makeConstraints:^(MASConstraintMaker *make) {
                        make.right.mas_offset(-Size(15));
                        make.centerY.equalTo(depositCell.contentView);
                    }];
                    [_depositBtn addTarget:self action:@selector(doDepositBtn:) forControlEvents:UIControlEventTouchUpInside];
                }
                depositCell.titleLab.text = @"职位押金开关";
                self.depositBtn.selected = self.postInitData.post.post_money_open == 0 ? NO : YES;
                return depositCell;
            }
                break;
            case 4:{
                if (self.depositBtn.selected) {
                    cell.titleLab.text = @"职位押金";
                    cell.textF.placeholder = @"请填写";
                    cell.textF.enabled = YES;
                    cell.textF.text = NSStringFromInteger(self.postInitData.post.post_money);
                    self.postMoneyTF = cell.textF;
                    self.postMoneyTF.delegate = self;
                    cell.textF.keyboardType = UIKeyboardTypeDecimalPad;
                }else{
                    cell.titleLab.text = @"公司地址";
                    cell.textF.placeholder = @"请填写";
                    cell.textF.enabled = YES;
                    cell.textF.adjustsFontSizeToFitWidth = YES;
                    cell.textF.minimumFontSize = 0.5;
                    cell.textF.text = self.postInitData.post.company_address;
                    self.companyAddressTF = cell.textF;
                    self.companyAddressTF.delegate = self;
                }
            }
                break;
            case 5:
                cell.titleLab.text = @"公司地址";
                cell.textF.placeholder = @"请填写";
                cell.textF.enabled = YES;
                cell.textF.adjustsFontSizeToFitWidth = YES;
                cell.textF.minimumFontSize = 0.5;
                cell.textF.text = self.postInitData.post.company_address;
                self.companyAddressTF = cell.textF;
                self.companyAddressTF.delegate = self;
                break;
            default:
                break;
        }
        return cell;
    }
    
    CELL_DEFINE(UITableViewCell);
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    return [UIView new];
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return Size(10);
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [self.view endEditing:YES];
    MineInfoTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if ([cell.titleLab.text isEqualToString:@"经验要求"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"经验要求";
        NSMutableArray *temp = [NSMutableArray array];
        for (Scale *s in AppDelegateInstance.gloableModel.data.companyWorkYear) {
            [temp addObject:s.value];
        }
        alert.titleArray = temp;
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.postInitData.post.work_year = AppDelegateInstance.gloableModel.data.companyWorkYear[index].ID;
            [self.tableV reloadData];
        };
        [alert show];
    }
    if ([cell.titleLab.text isEqualToString:@"行业类别"]) {
        ChoseTradeViewController *vc = [ChoseTradeViewController new];
        vc.multipleCount = 1;
        vc.tradeSelectedBlock = ^(NSDictionary * _Nonnull tradeDic) {
            Children *c = [tradeDic[@"tradeArr"] objectAtIndex:0];
            self.postInitData.post.industry_class_id = c.value;
            self.postInitData.post.industry_class = c.label;
            [self.tableV reloadData];
        };
        [self.navigationController pushViewController:vc animated:YES];
    }
    if ([cell.titleLab.text isEqualToString:@"学历要求"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"学历要求";
        NSMutableArray *temp = [NSMutableArray array];
        for (Scale *s in AppDelegateInstance.gloableModel.data.eduLevel) {
            [temp addObject:s.value];
        }
        alert.titleArray = temp;
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.postInitData.post.education_level = AppDelegateInstance.gloableModel.data.eduLevel[index].ID;
            [self.tableV reloadData];
        };
        [alert show];
    }
    if ([cell.titleLab.text isEqualToString:@"就职区域"]) {
        YMAddressPickView *pick = [[YMAddressPickView alloc]initWithUI:0 y:kScreenHeight-250 width:kScreenWidth height:250];
        pick.AdressBlock = ^(NSString *province, NSString *city, NSString *town, NSString *pid, NSString *cid, NSString *tid) {
            self.postInitData.post.work_address_region = town;
            self.postInitData.post.work_address_region_id = tid.integerValue;
            [self.tableV reloadData];
        };
        [pick showBottomView];
    }
}

#pragma mark - textField delegate
-(void)textFieldDidEndEditing:(UITextField *)textField{
    
    if (textField == self.jobNameTF) {
        self.postInitData.post.job_name = textField.text;
    }
    if (textField == self.departmentTF) {
        self.postInitData.post.department = textField.text;
    }
    if (textField == self.companyAddressTF) {
        self.postInitData.post.company_address = textField.text;
    }
    if (textField == self.postMoneyTF) {
        self.postInitData.post.post_money = textField.text.integerValue;
    }
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
