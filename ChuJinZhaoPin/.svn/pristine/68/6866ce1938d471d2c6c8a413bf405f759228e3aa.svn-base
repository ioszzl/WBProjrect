//
//  ResumeDetailViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/12.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "ResumeDetailViewController.h"
#import "ResumeMineInfoView.h"
#import "ResumJobIntensionTableViewCell.h"
#import "ResumeExperienceTableViewCell.h"
#import "ResumeProjectTableViewCell.h"
#import "ResumeEducationTableViewCell.h"
#import "ResumeCertificateTableViewCell.h"
#import "ResumeHeaderView.h"
#import "ResumeDetailModel.h"
#import "ChatViewController.h"
#import "ZHShareTool.h"
@interface ResumeDetailViewController ()<UITableViewDelegate,UITableViewDataSource>
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) UIButton *contactCompanyBtn;
@property (nonatomic, strong) UIButton *sendBtn;
@property (nonatomic, strong) UIButton *collectBtn;
@property (nonatomic, strong) ResumeMineInfoView *mineInfoV;

@property (nonatomic, strong) ResumeDetailModel *model;
//@property (nonatomic, strong) ResumeDetailData *dataSourceM;


@end

@implementation ResumeDetailViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
   
    [self initUI];
    
    [self requestDetailData];
}


-(void)initUI{
    
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithImage:[UIImage imageNamed:@"分享"] style:UIBarButtonItemStyleDone target:self action:@selector(doForward)];
    self.navigationItem.rightBarButtonItem = item;
    
    
    UIView *bottomV = [UIView new];
    bottomV.backgroundColor = RGBCOLOR(255, 255, 255);
    bottomV.layer.borderWidth = 0.5;
    bottomV.layer.borderColor = RGBCOLOR(230, 230, 230).CGColor;
    [self.view addSubview:bottomV];
    [bottomV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.mas_offset(0);
        make.height.mas_equalTo(Size(120/2)+kSecrityHeight);
    }];
    
    _collectBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    [_collectBtn setImage:[UIImage imageNamed:@"职位详情-收藏01"] forState:UIControlStateNormal];
    [_collectBtn setImage:[UIImage imageNamed:@"职位详情-收藏02"] forState:UIControlStateSelected];
    [bottomV addSubview:_collectBtn];
    [_collectBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.left.mas_offset(0);
        make.width.mas_equalTo(Size(152/2));
        make.height.mas_equalTo(Size(120/2));
    }];
    [_collectBtn addTarget:self action:@selector(doCollectBtn:) forControlEvents:UIControlEventTouchUpInside];
    
    UIView *line = [UIView new];
    line.backgroundColor = RGBCOLOR(230, 230, 230);
    [bottomV addSubview:line];
    [line mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(_collectBtn.mas_right);
        make.top.bottom.mas_offset(0);
        make.width.mas_equalTo(0.5);
    }];
    
    _contactCompanyBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"与他联系" backgroundColor:COLOR_MAIN_ENTERPRISE titleColor:RGBCOLOR(255, 255, 255) titleSize:Size(15)];
    _contactCompanyBtn.layer.cornerRadius = Size(5);
    [_contactCompanyBtn setImage:[UIImage imageNamed:@"联系企业"] forState:UIControlStateNormal];
    [bottomV addSubview:_contactCompanyBtn];
    [_contactCompanyBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(line.mas_right).mas_offset(Size(38/2));
        make.top.mas_offset(Size(10));
        make.width.mas_equalTo(Size(245/2));
        make.height.mas_equalTo(Size(40));
    }];
    [_contactCompanyBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(10)];
    [_contactCompanyBtn addTarget:self action:@selector(doContactBtn) forControlEvents:UIControlEventTouchUpInside];
    
    _sendBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"邀请投递" backgroundColor:nil titleColor:RGBCOLOR(255, 255, 255) titleSize:Size(15)];
    _sendBtn.layer.cornerRadius = Size(5);
    _sendBtn.clipsToBounds = YES;
    _sendBtn.titleLabel.adjustsFontSizeToFitWidth = YES;
    [_sendBtn setBackgroundImage:[UIImage ym_imageWithColor:COLOR_MAIN_PERSON size:CGSizeMake(Size(254/2), Size(40))] forState:UIControlStateNormal];
    [_sendBtn setImage:[UIImage imageNamed:@"职位详情-投递简历"] forState:UIControlStateNormal];
    
    [_sendBtn setTitle:@"已邀请" forState:UIControlStateDisabled];
    [_sendBtn setImage:[UIImage imageNamed:@"职位详情-投递简历"] forState:UIControlStateDisabled];
    [_sendBtn setBackgroundImage:[UIImage ym_imageWithColor:RGBCOLOR(102, 102, 102) size:CGSizeMake(Size(254/2), Size(40))] forState:UIControlStateDisabled];
    
    [_sendBtn setTitle:@"求职者已投递" forState:UIControlStateSelected];
    [_sendBtn setContentEdgeInsets:UIEdgeInsetsMake(0, Size(5), 0, Size(5))];
    [_sendBtn setBackgroundImage:[UIImage ym_imageWithColor:COLOR_MAIN_ENTERPRISE size:CGSizeMake(Size(254/2), Size(40))] forState:UIControlStateSelected];
    
    [bottomV addSubview:_sendBtn];
    [_sendBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(_contactCompanyBtn.mas_right).mas_offset(Size(36/2));
        make.top.mas_offset(Size(10));
        make.width.mas_equalTo(Size(245/2));
        make.height.mas_equalTo(Size(40));
    }];
    [_sendBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(10)];
    [_sendBtn addTarget:self action:@selector(doSendBtn) forControlEvents:UIControlEventTouchUpInside];
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:self.tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.right.left.mas_offset(0);
        make.bottom.equalTo(bottomV.mas_top);
    }];
    _tableV.rowHeight = UITableViewAutomaticDimension;
    
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(200))];
    _tableV.tableHeaderView = view;
    
    ResumeMineInfoView *mineInfoV = [[ResumeMineInfoView alloc]init];
    mineInfoV.layer.cornerRadius = Size(5);
    [view addSubview:mineInfoV];
    [mineInfoV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.mas_offset(Size(15));
        make.right.mas_offset(-Size(15));
        make.bottom.mas_offset(-Size(10));
    }];
    self.mineInfoV = mineInfoV;
    
    mineInfoV.editInfoBtn.hidden = YES;
//    mineInfoV.nameLab.text = @"哈哈哈";
//    mineInfoV.genderLab.text = @"女";
//    mineInfoV.ageLab.text = @"23岁";
//    mineInfoV.educationLab.text = @"本科";
//    [mineInfoV.phoneBtn setTitle:@"18726615487" forState:UIControlStateNormal];
//    [mineInfoV.phoneBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
//
//    [mineInfoV.emailBtn setTitle:@"chenxiaoming@11.com" forState:UIControlStateNormal];
//    [mineInfoV.emailBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];

}
-(void)updateTableVHead{
    self.title = self.model.data.resume.workJob;
    
    self.mineInfoV.nameLab.text = self.model.data.resume.tCjUserLoginDto.tCjUserInfoDto.realName;
    [self.mineInfoV.headImgV sd_setImageWithURL:[NSURL URLWithString:self.model.data.resume.tCjUserLoginDto.headPic] placeholderImage:[UIImage imageNamed:@"头像"]];
    self.mineInfoV.genderLab.text = [self.model.data.resume.tCjUserLoginDto.tCjUserInfoDto.sex isEqualToString:@"1"] ? @"女" : @"男";
    self.mineInfoV.ageLab.text = [NSString stringWithFormat:@"%ld岁",self.model.data.resume.tCjUserLoginDto.tCjUserInfoDto.age];
    self.mineInfoV.educationLab.text = self.model.data.resume.tCjUserLoginDto.tCjUserInfoDto.maxEduLevelStr;//@"本科";
    [self.mineInfoV.phoneBtn setTitle:self.model.data.resume.tCjUserLoginDto.tCjUserInfoDto.ceilPhone forState:UIControlStateNormal];
    [self.mineInfoV.phoneBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
    
    [self.mineInfoV.emailBtn setTitle:self.model.data.resume.tCjUserLoginDto.tCjUserInfoDto.email forState:UIControlStateNormal];
    [self.mineInfoV.emailBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
    
    
    if (self.model.data.isCollect == 0) {//0:未收藏1:收藏
        self.collectBtn.selected = NO;
    }else{
        self.collectBtn.selected = YES;
    }
    
    if (self.model.data.resume.inviteStatus == 0) {//0:未邀请投递,1:已邀请投递
        self.sendBtn.enabled = YES;
    }else{
        self.sendBtn.enabled = NO;
    }
}


#pragma mark - request
-(void)requestDetailData{
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.resumeId forKey:@"resumeId"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appResumeDetailOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            self.model = [ResumeDetailModel mj_objectWithKeyValues:data];
            [self updateTableVHead];
            [self.tableV reloadData];
        }
    });
}
#pragma mark - action
-(void)doForward{
    //self.model.data.shareUrl;//简历分享url
    NSDictionary *dic = @{@"title":self.title,
                          @"descr":@"新起点直聘",
                          @"imagesStr":@"AppIcon",
                          @"webpageUrl":self.model.data.shareUrl
                          };
    [ZHShareTool shareWithDic:dic shareCompletionBlock:^(BOOL success, UMSocialPlatformType platformType) {
        
    }];
}

-(void)doCollectBtn:(UIButton *)btn{
    
    if (btn.selected) {
        NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
        [dataDic setValue:NSStringFromInteger(self.model.data.collectId) forKey:@"collectId"];
        
        NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
        [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
        [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
        
        [[RHNetAPIManager sharedManager]appCannelResumeCollectionOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
            if (data) {
                [HUD showHUDSuccess:nil title:@"已取消"];
                btn.selected = !btn.selected;
            }
        });
    }else{
        NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
        [dataDic setValue:self.resumeId forKey:@"resumeId"];
        
        NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
        [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
        [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
        
        [[RHNetAPIManager sharedManager]appCollectResumeOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
            if (data) {
                [HUD showHUDSuccess:nil title:@"已收藏"];
                if (![data[@"data"] isMemberOfClass:[NSNull class]]) {
                    self.model.data.collectId = [data[@"data"] integerValue];
                }
                
                btn.selected = !btn.selected;
            }
        });
    }
    
    
}

-(void)doContactBtn{
    ChatViewController *vc = [ChatViewController new];
    vc.sendId = NSStringFromInteger(self.model.data.resume.tCjUserLoginDto.ID);
    //self.model.data.resume.tCjUserLoginDto.ID//简历所属用户的id
    vc.resumeId = self.resumeId;
    [self.navigationController pushViewController:vc animated:YES];
}
-(void)doSendBtn{
//    _sendBtn.selected = !_sendBtn.selected;
//    [_sendBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(4)];
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.resumeId forKey:@"resumeId"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appInviteSendResumeOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            if (code == 5000) {
                [HUD showHUDError:nil title:data[@"data"]];
            }else{
                [HUD showHUDSuccess:nil title:@"已邀请"];
                _sendBtn.enabled = NO;
            }
            
        }
        
    });
}

#pragma mark - tableview delegate
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 5;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    switch (section) {
        case 0:{//求职意向
            if (self.model.data.resume.workJob.length == 0) {
                return 0;
            }
            return 1;
        }
            break;
        case 1:{//工作经验
            
            return self.model.data.resume.resumeWorkExperienceList.count;
        }
            break;
        case 2:{//项目经验
            
            return self.model.data.resume.resumeProjectExperienceList.count;
        }
            break;
        case 3:{//教育经历
            
            return self.model.data.resume.resumeEduExperienceList.count;
        }
            break;
        case 4:{//技能证书
            
            return self.model.data.resume.resumeSkillPointList.count;
        }
            break;
        default:
            break;
    }
    
    return 0;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    switch (indexPath.section) {
        case 0:{//求职意向
            CELL_DEFINE(ResumJobIntensionTableViewCell);
            cell.editBtn.hidden = YES;
            cell.moneyLab.text = self.model.data.resume.wantSalary;//@"8000-10000元/月";
            cell.locationLab.text = self.model.data.resume.positionLocationdes;//@"深圳";
            cell.positionLab.text = self.model.data.resume.workJob;//@"产品专员";
            cell.tradeLab.text = self.model.data.resume.workClassName;//@"互联网/电子商务";
            cell.tagsLab.text = self.model.data.resume.personDesCard;//@"Asure Visio Xmind";
            cell.evaluationLab.text = self.model.data.resume.selfEvaluate;//@"哈哈哈哈哈哈哈啥哈哈哈哈哈哈哈哈哈哈哈啊更好嘎嘎嘎嘎哈哈哈哈哈哈嘎嘎嘎嘎嘎嘎阿嘎嘎嘎个渐进色哈哈哈啊嘎嘎嘎嘎嘎嘎阿哥";
            cell.jobTypeLab.text = [self.model.data.resume.jobType isEqualToString:@"0"] ? @"全职" : @"兼职";
            return cell;
        }
            break;
        case 1:{//工作经验
            CELL_DEFINE(ResumeExperienceTableViewCell);
            ResumeDetailWorkExperienceList *list = self.model.data.resume.resumeWorkExperienceList[indexPath.row];
            cell.editBtn.hidden = YES;
            cell.dateLab.text = [NSString stringWithFormat:@"%@-%@", [[NSDate dateWithTimeIntervalSince1970:list.startTime/1000] stringWithFormat:@"yyyy-MM-dd"], [[NSDate dateWithTimeIntervalSince1970:list.endTime/1000] stringWithFormat:@"yyyy/MM/dd"]];//@"2016-07-2017-07";
            cell.departmentLab.text = list.department;//@"设计部";
            cell.companyLab.text = list.locCompany;//@"深圳英迈思文化科技有限公司";
            cell.positionLab.text = list.workPosition;//@"产品经理";
            cell.jobContentLab.text = list.workDescrib;//@"1、是淡黄色的解放军开始的就开始打卡时间段的说法结束的哈吉斯\n2、三大见好就收的规范化和搜嘎导航返回是华盛顿股份\n2、三大见好就收的规范化和搜嘎导航返回是华盛顿股份\n2、三大见好就收的规范化和搜嘎导航返回是华盛顿股份\n2、三大见好就收的规范化和搜嘎导航返回是华盛顿股份\n2、三大见好就收的规范化和搜嘎导航返回是华盛顿股份";
            
            if (indexPath.row == self.model.data.resume.resumeWorkExperienceList.count -1) {
                cell.hiddenLine = YES;
            }else{
                cell.hiddenLine = NO;
            }
            return cell;
        }
            break;
        case 2:{//项目经验
            CELL_DEFINE(ResumeProjectTableViewCell);
            ResumeDetailProjectExperienceList *list = self.model.data.resume.resumeProjectExperienceList[indexPath.row];
            cell.editBtn.hidden = YES;
            cell.nameLab.text = list.proName;//@"O2O书店平台";
            cell.dateLab.text = [NSString stringWithFormat:@"%@-%@",[[NSDate dateWithTimeIntervalSince1970:list.startTime/1000]stringWithFormat:@"yyyy/MM"], [[NSDate dateWithTimeIntervalSince1970:list.endTime/1000] stringWithFormat:@"yyyy/MM"]];//@"2017/7-2018/8";
            cell.contenLab.text = list.proDescrib;//@"和时代感和哈哈哈哈哈哈哈哈哈啥哈哈少时诵诗书所哈哈哈哈哈哈咔咔咔咔咔咔解决解决军军啊啊啊啊啊啊啊啊啊啊啊";
            if (indexPath.row == self.model.data.resume.resumeProjectExperienceList.count -1) {
                cell.hiddenLine = YES;
            }else{
                cell.hiddenLine = NO;
            }
            return cell;
        }
            break;
        case 3:{//教育经历
            CELL_DEFINE(ResumeEducationTableViewCell);
            ResumeDetailEduExperienceList *list = self.model.data.resume.resumeEduExperienceList[indexPath.row];
            cell.editBtn.hidden = YES;
            cell.dateLab.text = [NSString stringWithFormat:@"%@-%@",[[NSDate dateWithTimeIntervalSince1970:list.startTime/1000]stringWithFormat:@"yyyy/MM"], [[NSDate dateWithTimeIntervalSince1970:list.endTime/1000] stringWithFormat:@"yyyy/MM"]];//@"2015/9-2018/6";
            cell.contentLab.text = [NSString stringWithFormat:@"%@    %@    %@",list.school, list.major, [AppDelegateInstance educationNameWithID:list.educationLevel]];//@"湖南理工大学    软件工程    本科";
            return cell;
        }
            break;
        case 4:{//技能证书
            CELL_DEFINE(ResumeCertificateTableViewCell);
            NSMutableArray *temp = [NSMutableArray array];
            for (ResumeDetailSkillPointList *list in self.model.data.resume.resumeSkillPointList) {
                [temp addObjectsFromArray:[list.skillName componentsSeparatedByString:@","]];
                [temp addObjectsFromArray:[list.credential componentsSeparatedByString:@","]];
            }
            cell.certificateArr = temp;//@[@"CET4", @"C语言二级",@"C语言二级",@"C语言二级"];
            return cell;
        }
            break;
        default:
            break;
    }
    CELL_DEFINE(UITableViewCell);
    return cell;

    
}
//-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
//    if (_edit) {
//        ResumJobIntensionTableViewCell *cell = (ResumJobIntensionTableViewCell *)[self tableView:tableView cellForRowAtIndexPath:indexPath];
//        return cell.cellH;
//    }else{
//        return Size(232/2+10);
//    }
//}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(44))];
    
    ResumeHeaderView *headV = [[ResumeHeaderView alloc]init];
    headV.frame = CGRectMake(Size(15), 0, kScreenWidth-Size(30), Size(44));
    UIBezierPath *maskPath = [UIBezierPath bezierPathWithRoundedRect:headV.bounds byRoundingCorners:(UIRectCornerTopLeft | UIRectCornerTopRight) cornerRadii:CGSizeMake(Size(5),Size(5))];//圆角大小
    CAShapeLayer *maskLayer = [[CAShapeLayer alloc] init];
    maskLayer.frame = headV.bounds;
    maskLayer.path = maskPath.CGPath;
    headV.layer.mask = maskLayer;
    [view addSubview:headV];
    headV.addBtn.hidden = YES;
    [headV.addBtn setImage:[UIImage imageNamed:@"职位详情++"] forState:(UIControlState)UIControlStateNormal];
    headV.imgV.image = [UIImage imageNamed:@"home_line_blue"];
    
    switch (section) {
        case 0:{
            headV.addBtn.hidden = YES;
            headV.titleLab.text = @"求职意向";
            
        }
            break;
        case 1:{
            headV.titleLab.text = @"工作经验";
            headV.addBtnBlock = ^{
                
            };
        }
            break;
        case 2:{
            headV.titleLab.text = @"项目经验";
            headV.addBtnBlock = ^{
                
            };
        }
            break;
        case 3:{
            headV.titleLab.text = @"教育经历";
            headV.addBtnBlock = ^{
                
            };
        }
            break;
        case 4:{
            [headV.addBtn setImage:[UIImage imageNamed:@"编辑"] forState:(UIControlState)UIControlStateNormal];
            
            headV.titleLab.text = @"技能证书";
            
        }
            break;
        default:
            break;
    }
    
    return view;
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return Size(44);
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    
    return Size(10);
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
