//
//  ContactMangeViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/15.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "ContactMangeViewController.h"
#import "MineInfoTableViewCell.h"
#import "AddContactViewController.h"
#import "ContactListModel.h"
@interface ContactMangeViewController ()<UITableViewDelegate,UITableViewDataSource>{
    NSIndexPath* _editingIndexPath;
    
    NSInteger _pageNum;
}
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSArray<ContactList *> *dataSource;

@end

@implementation ContactMangeViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self initUI];
}
-(void)initUI{
    self.title = @"联系人管理";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithImage:[UIImage imageNamed:@"add"] style:UIBarButtonItemStyleDone target:self action:@selector(doAddItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStylePlain];
    _tableV.tableFooterView = [UIView new];
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_updateConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    
    _tableV.mj_header = [YMRefreshHeader ym_headerWithRefreshingsBlock:^{
        _pageNum = 1;
        [self requestListData];
    } animated:NO];
    
    _tableV.mj_footer = [YMRefreshFooter ym_footerWithRefreshingsBlock:^{
        _pageNum++;
        [self requestListData];
    } animated:NO];
    
}
-(void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    
    _pageNum = 1;
    [self requestListData];
}
#pragma mark - request
-(void)requestListData{
    NSMutableDictionary *pageDic = [NSMutableDictionary dictionary];
    [pageDic setValue:NSStringFromInteger(_pageNum) forKey:@"currPage"];
    [pageDic setValue:@"10" forKey:@"pageSize"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[pageDic mj_JSONString] forKey:@"page"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appCompanyContactsListOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            ContactListModel *model = [ContactListModel mj_objectWithKeyValues:data];
    
            if (_pageNum == 1) {
                self.dataSource = model.data.list;
                [self.tableV.mj_header endRefreshing];
                [self.tableV.mj_footer resetNoMoreData];
            }else{
                NSMutableArray *temp = [NSMutableArray arrayWithArray:self.dataSource];
                [temp addObjectsFromArray:model.data.list];
                self.dataSource = [temp copy];
            }
            if (model.data.isLastPage) {
                [self.tableV.mj_footer endRefreshingWithNoMoreData];
            }else{
                [self.tableV.mj_footer endRefreshing];
            }
            
            [self.tableV reloadData];
            
        }else{
            
            [self.tableV.mj_header endRefreshing];
            [self.tableV.mj_footer endRefreshing];
        }
        
    });
}
#pragma mark - action
-(void)doAddItem{
    AddContactViewController *vc = [AddContactViewController new];
    [self.navigationController pushViewController:vc animated:YES];
}

#pragma mark - tableView delegate
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.dataSource.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(MineInfoTableViewCell);
    cell.textF.enabled = NO;
    ContactList *list = self.dataSource[indexPath.row];
    cell.titleLab.text = list.userName;//@"王思聪";
    cell.textF.text = list.phone;//@"1345255";
    return cell;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return Size(120/2);
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    AddContactViewController *vc = [AddContactViewController new];
    vc.list = self.dataSource[indexPath.row];
    [self.navigationController pushViewController:vc animated:YES];
}

-(BOOL)tableView:(UITableView *)tableView canEditRowAtIndexPath:(NSIndexPath *)indexPath{
    return YES;
}
-(UITableViewCellEditingStyle)tableView:(UITableView *)tableView editingStyleForRowAtIndexPath:(NSIndexPath *)indexPath{
    return UITableViewCellEditingStyleDelete;
}
-(NSString *)tableView:(UITableView *)tableView titleForDeleteConfirmationButtonForRowAtIndexPath:(NSIndexPath *)indexPath{
    //[self configSwipeButtons];
    return @"删除";
}
- (void)tableView:(UITableView *)tableView willBeginEditingRowAtIndexPath:(NSIndexPath *)indexPath{
    //[self.view setNeedsDisplay];
    //[self viewDidLayoutSubviews];
    [self configSwipeButtons];
}
-(void)tableView:(UITableView *)tableView commitEditingStyle:(UITableViewCellEditingStyle)editingStyle forRowAtIndexPath:(NSIndexPath *)indexPath{
    
    ContactList *list = self.dataSource[indexPath.row];
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:NSStringFromInteger(list.ID) forKey:@"id"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appDeleteCompanyContanctOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            [HUD showHUDError:nil title:@"已删除"];
            
            _pageNum = 1;
            [self requestListData];
        }
    });
}

- (void)configSwipeButtons{
    // 获取选项按钮的reference
    if (SYSTEM_VERSION >= 11.0)
    {
        for (UIView *subview in self.tableV.subviews)
        {
            if ([subview isKindOfClass:NSClassFromString(@"UISwipeActionPullView")] && [subview.subviews count] > 0)
            {
                
                subview.backgroundColor = HEXRGBCOLOR(0xeeeeee);
                [subview.subviews[0] removeFromSuperview];
                UIButton *deleteButton = [UIButton buttonWithType:UIButtonTypeCustom] ;
                
                [deleteButton setTitleColor:COLOR_MAIN forState:UIControlStateNormal] ;
                [deleteButton setTitle:@"删除" forState:UIControlStateNormal];
                deleteButton.titleLabel.font = FONT_SIZE_12;
                deleteButton.backgroundColor = [UIColor whiteColor];
                deleteButton.left = 1;
                deleteButton.top = 0;
                deleteButton.height = Size(60);
                deleteButton.width = Size(76);
                [deleteButton addTarget:self action:@selector(deleteCell) forControlEvents:UIControlEventTouchUpInside];
                [subview addSubview:deleteButton];
            }
        }
    }
    
}
-(void)deleteCell{
    [self tableView:self.tableV commitEditingStyle:UITableViewCellEditingStyleDelete forRowAtIndexPath:_editingIndexPath];
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
