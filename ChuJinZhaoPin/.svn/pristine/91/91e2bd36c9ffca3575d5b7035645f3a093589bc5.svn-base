//
//  SkillViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/10.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "SkillViewController.h"
#import "SkillTableViewCell.h"
#import "SkillCertificateHeaderView.h"
#import "SkillModel.h"
@interface SkillViewController ()<UITableViewDelegate,UITableViewDataSource>
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSMutableArray *skillArr;
@property (nonatomic, strong) NSMutableArray *certificateArr;

@property (nonatomic, strong) SkillModel *model;
@end

@implementation SkillViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    
    if (self.skillId) {
        [self requestInitData];
    }
}

-(void)initUI{
    self.title = @"技能证书";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveBarItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.separatorInset = UIEdgeInsetsMake(0, 0, 0, 0);
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    
    
}

#pragma mark - request
-(void)requestInitData{
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.skillId forKey:@"id"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appGetResumeSkillPointByIdOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            self.model = [SkillModel mj_objectWithKeyValues:data];
            if (self.model.data.skillName.length != 0) {
                self.skillArr = [[self.model.data.skillName componentsSeparatedByString:@","] mutableCopy];
            }
            if (self.model.data.credential.length != 0) {
                self.certificateArr = [[self.model.data.credential componentsSeparatedByString:@","] mutableCopy];
            }
            
            
            [self.tableV reloadData];
        }
    });
}

#pragma mark - actiom
-(void)doSaveBarItem{
    if (self.skillArr.count == 0 && self.certificateArr.count == 0) {
        [HUD showHUDError:nil title:@"请添加技能/c证书"];
        return;
    }
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.skillId forKey:@"id"];
    [dataDic setValue:self.resumeId forKey:@"resumeId"];
    [dataDic setValue:[self.skillArr componentsJoinedByString:@","] forKey:@"skillName"];
    [dataDic setValue:[self.certificateArr componentsJoinedByString:@","] forKey:@"credential"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddOrEditResumeSkillPointOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (dataDic) {
            [HUD showHUDError:nil title:@"已保存"];
            BLOCK_EXEC(self.addResumeBlock,[data valueForKey:@"data"]);
            [self.navigationController popViewControllerAnimated:YES];
        }
    });
}

#pragma mark - tableview delegate
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return self.skillArr.count;
    }
    return self.certificateArr.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(SkillTableViewCell);
    if (indexPath.section == 0) {
        cell.textLab.text = self.skillArr[indexPath.row];
    }else{
        cell.textLab.text = self.certificateArr[indexPath.row];
    }
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(398/2))];
    
    SkillCertificateHeaderView *headV = [[SkillCertificateHeaderView alloc]init];
    [view addSubview:headV];
    [headV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(view);
    }];
    if (section == 0) {
        headV.titleLab.text= @"技能";
        [headV.addBtn setTitle:@"+ 技能" forState:UIControlStateNormal];
        headV.addBtnBlock = ^(NSString * _Nonnull text) {
            if (text.length == 0) {
                [HUD showHUDError:nil title:@"技能不能为空"];
                return ;
            }
            [self.skillArr addObject:text];
            [self.tableV reloadData];
        };
    }else{
        headV.titleLab.text = @"证书";
        [headV.addBtn setTitle:@"+ 证书" forState:UIControlStateNormal];
        headV.addBtnBlock = ^(NSString * _Nonnull text) {
            if (text.length == 0) {
                [HUD showHUDError:nil title:@"证书不能为空"];
                return ;
            }
            [self.certificateArr addObject:text];
            [self.tableV reloadData];
        };
    }
    
    
    return view;
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return Size(398/2);
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}

#pragma mark - 懒加载
-(NSMutableArray *)skillArr{
    if (!_skillArr) {
        _skillArr = [NSMutableArray array];
    }
    return _skillArr;
}
-(NSMutableArray *)certificateArr{
    if (!_certificateArr) {
        _certificateArr = [NSMutableArray array];
    }
    return _certificateArr;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
