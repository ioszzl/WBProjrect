//
//  CommentDetailViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/5.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "CommentDetailViewController.h"
#import "JobRequireView.h"
#import "CompanyScoreView.h"
#import "JobCommentTableViewCell.h"
#import "CommentDetailModel.h"
#import "CompanyDetailViewController.h"
@interface CommentDetailViewController ()<UITableViewDelegate,UITableViewDataSource>{
    NSInteger _pageNum;
    
}
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSArray<CommentDetailList *> *dataSource;
@property (nonatomic, strong) JobRequireView *requireView;
@property (nonatomic, strong) CompanyScoreView *scoreView;

@end

@implementation CommentDetailViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    
    _pageNum = 1;
    [self requestLitData];
}
-(void)initUI{
    self.title = @"用户评价";
    
   
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.tableFooterView = [UIView new];
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    
    _tableV.mj_header = [YMRefreshHeader ym_headerWithRefreshingsBlock:^{
        _pageNum = 1;
        [self requestLitData];
    } animated:NO];
    _tableV.mj_footer = [YMRefreshFooter ym_footerWithRefreshingsBlock:^{
        _pageNum++;
        [self requestLitData];
    } animated:NO];
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(218/2+70/2) + Size(152/2))];
    _tableV.tableHeaderView = view;
    
    JobRequireView *requireView = [[JobRequireView alloc]initWithFrame:CGRectZero];
    requireView.callBtn.hidden = YES;
    [view addSubview:requireView];
    [requireView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.right.mas_offset(0);
        make.height.mas_equalTo(Size(218/2+70/2));
    }];
    self.requireView = requireView;
    
    CompanyScoreView *scoreView = [[CompanyScoreView alloc]initWithFrame:CGRectZero];
    [view addSubview:scoreView];
    [scoreView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(requireView.mas_bottom);
        make.height.mas_equalTo(Size(152/2));
    }];
    self.scoreView = scoreView;
    
    [self updateUI];
}

-(void)updateUI{
    self.requireView.nameLab.text = self.jobDetailM.data.job_name;//@"产品经理";
    self.requireView.moneyLab.text = self.jobDetailM.data.show_range;//@"7~9K";
    self.requireView.yearLab.text = [AppDelegateInstance userWorkYearNameWithID:self.jobDetailM.data.work_year];//@"1-3年";
    self.requireView.educationLab.text = [AppDelegateInstance educationNameWithID:self.jobDetailM.data.education_level];//@"本科";
    self.requireView.tradeLab.text = self.jobDetailM.data.industry_class;//@"移动互联网";
    if (self.jobDetailM.data.post_money_open == 1) {
        self.requireView.depositLab.hidden = NO;
        self.requireView.payLab.text = [NSString stringWithFormat:@"¥%ld",self.jobDetailM.data.min_value];//@"¥20";
    }else{
        self.requireView.depositLab.hidden = YES;
        self.requireView.payLab.text = @"";
    }
    
    self.requireView.addressLab.text = self.jobDetailM.data.company_address;//@"北京市 海淀区中关村科贸电子城7层";
    if (![self.jobDetailM.data.fl isEqual:@""]) {
        self.requireView.markArr = self.jobDetailM.data.fl;
    }
    
    [self.scoreView.iconV sd_setImageWithURL:[NSURL URLWithString:self.jobDetailM.data.companyMap.logoUrl] placeholderImage:[UIImage imageNamed:@"附近职位logo"]];
    self.scoreView.nameLab.text = self.jobDetailM.data.companyMap.company_name;//@"好未来";
    self.scoreView.countLab.text = [NSString stringWithFormat:@"在招职位%ld个",self.jobDetailM.data.companyMap.postNum];//@"在招职位80个";
    self.scoreView.scoreLab.text = [NSString stringWithFormat:@"%@分",JUDGE_NUll_DEF(self.jobDetailM.data.companyMap.scoreMap.totalStar, @"0.0")];//@"4.4分";
    self.scoreView.score = JUDGE_NUll_DEF(self.jobDetailM.data.companyMap.scoreMap.totalStar, @"0.0");
    
    
    WEAKSELF;
    self.scoreView.tapBlock = ^{
        NSLog(@"tap");
        CompanyDetailViewController *vc = [CompanyDetailViewController new];
        vc.companyId = weakSelf.companyId;
        [weakSelf.navigationController pushViewController:vc animated:YES];
    };
}
#pragma mark - request
-(void)requestLitData{
    NSMutableDictionary *pageDic = [NSMutableDictionary dictionary];
    [pageDic setValue:NSStringFromInteger(_pageNum) forKey:@"currPage"];
    [pageDic setValue:@"10" forKey:@"pageSize"];
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.postId forKey:@"postId"];
    [dataDic setValue:self.companyId forKey:@"companyId"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    [paramDic setValue:[pageDic mj_JSONString] forKey:@"page"];
    
    [[RHNetAPIManager sharedManager]appUserFindCommentListOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            CommentDetailModel *model = [CommentDetailModel mj_objectWithKeyValues:data];
            if (_pageNum == 1) {
                self.dataSource = model.data.comment.list;
                [self.tableV.mj_header endRefreshing];
                [self.tableV.mj_footer resetNoMoreData];
            }else{
                NSMutableArray *temp = [NSMutableArray arrayWithArray:self.dataSource];
                [temp addObjectsFromArray:model.data.comment.list];
                self.dataSource = [temp copy];
            }
            if (model.data.comment.isLastPage) {
                [self.tableV.mj_footer endRefreshingWithNoMoreData];
            }else{
                [self.tableV.mj_footer endRefreshing];
            }
            
            [self.tableV reloadData];
        }else{
            [self.tableV.mj_header endRefreshing];
            [self.tableV.mj_footer endRefreshing];
        }
    });
}
#pragma mark - tableView delegate
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.dataSource.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(JobCommentTableViewCell)
    cell.commentType = commentDetailTypeComment;
    CommentDetailList *list = self.dataSource[indexPath.row];
    cell.list = list;
    WeakSelf(cell);
    cell.likeBtnBlock = ^(UIButton * _Nonnull btn) {
        NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
        [dataDic setValue:NSStringFromInteger(list.ID) forKey:@"commentId"];
        if ([list.isGood isEqualToString:@"n"]) {//是否点赞(y否,n是)
            //type = 1 点赞  type = 0 取消点赞
            [dataDic setValue:@"0" forKey:@"type"];
        }else{
            [dataDic setValue:@"1" forKey:@"type"];
        }
        
        NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
        [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
        [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
        
        [[RHNetAPIManager sharedManager]appUserGoodCountOPT:paramDic].hiddenLoading().start(^(id data, NSString *msg, NSInteger code, NSError *error) {
            if (data) {
                _pageNum = 1;
                [self requestLitData];
//                if ([list.isGood isEqualToString:@"n"]) {//是否点赞(y否,n是)
//                    list.isGood = @"y";
//                    list.goodCounts -= 1;
//                }else{
//                    list.isGood = @"n";
//                    list.goodCounts += 1;
//                }
//                [tableView reloadRowsAtIndexPaths:@[indexPath] withRowAnimation:UITableViewRowAnimationNone];
            }
        });
    };
    return cell;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return Size(308/2);
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
