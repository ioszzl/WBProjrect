//
//  HomeViewController.m
//  TestDemo
//
//  Created by 孙若淮 on 15/03/2018.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "HomeViewController.h"
#import "TYPageControl.h"
#import "TYCyclePagerView.h"
#import "TYCyclePagerViewCell.h"
#import "CompleteInformationAlertView.h"
#import "SliderNewsTableViewCell.h"
#import "HomeJobListTableViewCell.h"
#import "SearchViewController.h"
#import "JobDetailViewController.h"
#import "CityFilterView.h"
#import "EducationFilterView.h"
#import "ChoseTradeViewController.h"
#import "CJAlertView.h"
#import "HomeModel.h"
#import "HomeIndexListModel.h"
#import "SearchResultViewController.h"
#import "MineHtmlViewController.h"
#import <CoreLocation/CoreLocation.h>
@interface HomeViewController ()<UITableViewDelegate,UITableViewDataSource,TYCyclePagerViewDataSource,TYCyclePagerViewDelegate,CLLocationManagerDelegate>{
    NSInteger _filterCityID;
    NSString *_filterCity;
    NSDictionary *_filterTradeDic;
    
    NSInteger _pageNum;
    
    BOOL _jumpInfo;
}
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) TYCyclePagerView *pagerView;
@property (nonatomic, strong) TYPageControl *pageControl;
@property (nonatomic, strong) NSArray<HomeIndexList *> *dataSource;

@property (nonatomic, strong) UIButton *cityBtn;
@property (nonatomic, strong) UIButton *otherBtn;
@property (nonatomic, strong) UIButton *tradeBtn;

@property (nonatomic, strong) CompleteInformationAlertView *completeInfoAlertV;
@property (nonatomic, strong) EducationFilterView *otherFliterV;
@property (nonatomic, strong) CityFilterView *cityFilterV;

//滚动头条内容
@property (nonatomic, strong) NSArray *topSignImageArr;
@property (nonatomic, strong) NSArray *topTitleArr;
@property (nonatomic, strong) NSArray *bottomSignImageArr;
@property (nonatomic, strong) NSArray *bottomTitleArr;

@property (nonatomic, strong) UIButton *positionBtn;

@property (nonatomic, strong) HomeModel *model;

@property (nonatomic, strong) NSMutableDictionary *paramDataDic;

@property (nonatomic, strong) CLLocationManager *locationManager;//定位服务管理类

@end

@implementation HomeViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    _jumpInfo = NO;
    
    _locationManager = [[CLLocationManager alloc] init];
    [_locationManager requestWhenInUseAuthorization];
    //[_locationManager requestAlwaysAuthorization];//iOS8必须，这两行必须有一行执行，否则无法获取位置信息，和定位
    // 设置定位精确度到米
    _locationManager.desiredAccuracy = kCLLocationAccuracyBest;
    // 设置过滤器为无
    _locationManager.distanceFilter = kCLDistanceFilterNone;
    // 设置代理
    _locationManager.delegate = self;
    if([self.locationManager respondsToSelector:@selector(requestWhenInUseAuthorization)]){
        
        [self.locationManager requestWhenInUseAuthorization];
    }
    
    [self.locationManager startUpdatingLocation];//开始定位
    
    //_topSignImageArr = @[@"toutiao", @"toutiao", @"toutiao"];
    //_topTitleArr = @[@"聚惠女王节，香米更低价满150减10", @"HTC新品首发，预约送大礼包", @"“挑食”进口生鲜，满199减20"];
    //_bottomSignImageArr = @[@"toutiao", @"toutiao", @"toutiao"];
    //_bottomTitleArr = @[@"满150减10+满79减5", @"12期免息＋免费试用", @"领券满199减20+进口直达"] ;
    
    [self initUI];
    
     [self requestBannerData];
}

-(void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    self.navigationController.navigationBar.translucent = YES;
    [self.navigationController.navigationBar setBackgroundImage:[UIImage new] forBarMetrics:UIBarMetricsDefault];
    [self.navigationController.navigationBar setShadowImage:[UIImage new]];
    
    [self scrollViewDidScroll:self.tableV];
}
-(void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
    
    self.navigationController.navigationBar.translucent = NO;
    [self.navigationController.navigationBar setBackgroundImage:nil forBarMetrics:UIBarMetricsDefault];
    [self.navigationController.navigationBar setShadowImage:nil];
    
}
-(void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    
    if ([self.paramDataDic valueForKey:@"workAddressRegion"]) {
        _pageNum = 1;
        [self requestListData];
    }
    
}
-(void)initUI{
    
    [self setNavi];
    [self.view addSubview:self.tableV];
    
    
    [self.suspendedBtn setImage:[UIImage imageNamed:@"客服"] forState:UIControlStateNormal];
    [self showSuspendedBtn:^(UIButton *btn) {
        
    }];
    
    
}
/**
 设置导航栏
 */
-(void)setNavi {
    //CGRectMake(0, 0, kScreenWidth, Size(30))
    UIView *bgView = [[UIView alloc]initWithFrame:CGRectMake(0, kStatusHeight, kScreenWidth, 44)];
    self.navigationItem.titleView = bgView;
//    [bgView mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.left.right.top.bottom.mas_offset(0);
//        //make.width.mas_equalTo(kScreenWidth);
//        //make.height.mas_equalTo(44);
//    }];
    
    UIButton *positionBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"深圳市" backgroundColor:nil titleColor:RGBCOLOR(255, 255, 255) titleSize:Size(12)];
    [positionBtn setImage:[UIImage imageNamed:@"xia"] forState:UIControlStateNormal];
    [bgView addSubview:positionBtn];
    [positionBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_offset(9);
        make.left.mas_offset(0);
        make.height.mas_equalTo(54/2);
        make.width.mas_equalTo(140/2);
    }];
    [positionBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
    self.positionBtn = positionBtn;
    
    [positionBtn addTarget:self action:@selector(doPositionBtn:) forControlEvents:UIControlEventTouchUpInside];
    
    UIView *searchView = [UIView new];
    searchView.layer.cornerRadius = 54/4;
    searchView.clipsToBounds = YES;
    searchView.backgroundColor = RGBCOLOR(255, 255, 255);
    [bgView addSubview:searchView];
    [searchView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(positionBtn.mas_right).mas_offset(Size(3));
        make.top.mas_offset(9);
        make.height.mas_equalTo(54/2);
        make.width.mas_equalTo(Size(493/2));
    }];
    
    UIImageView *searchImageView = [[UIImageView alloc]initWithImage:[UIImage imageNamed:@"首页搜索"]];
    searchImageView.contentMode = UIViewContentModeScaleAspectFit;
    [searchView addSubview:searchImageView];
    [searchImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(8));
        make.width.mas_equalTo(Size(24/2));
        make.top.bottom.mas_offset(0);
    }];
    
    UILabel *searchLabel = [[UILabel alloc]initWithFrame:CGRectZero];
    searchLabel.text = @"搜索职位/名称";
    searchLabel.font = [UIFont systemFontOfSize:Size(12)];
    searchLabel.textColor = COLOR_RGB_153;
    [searchView addSubview:searchLabel];
    [searchLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(searchImageView.mas_right).mas_offset(Size(5));
        make.width.mas_equalTo(Size(410/2));
        make.top.bottom.mas_offset(0);
    }];
    
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(doSearchView)];
    [searchView addGestureRecognizer:tap];
    
    
    UIButton *menuBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    [menuBtn setImage:[UIImage imageNamed:@"菜单"] forState:UIControlStateNormal];
    menuBtn.imageView.contentMode = UIViewContentModeScaleAspectFit;
    [menuBtn addTarget:self action:@selector(doMenuBtn) forControlEvents:UIControlEventTouchUpInside];
    [bgView addSubview:menuBtn];
    [menuBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(searchView.mas_right).mas_offset(Size(15));
        make.centerY.equalTo(searchView);
    }];

    
    
    
}
#pragma mark - request

-(void)requestBannerData{
   
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appUserIndexOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            self.model = [HomeModel mj_objectWithKeyValues:data];
            
            
            if (self.model.data.hasRealName == 0) {//是否需要完善信息(0:需要,1:不需要)
                self.completeInfoAlertV.hidden = _jumpInfo;
            }
            NSMutableArray *temp1 = [NSMutableArray array];
            NSMutableArray *temp11 = [NSMutableArray array];
            NSMutableArray *temp2 = [NSMutableArray array];
            NSMutableArray *temp21 = [NSMutableArray array];
            
            NSMutableArray *tempArr = [NSMutableArray arrayWithArray:self.model.data.userTtComment];
            if (self.model.data.userTtComment.count % 2 != 0) {
                [tempArr addObject:@""];
            }
//            [tempArr addObject:@"2222"];
//            [tempArr addObject:@"3333"];
            for (int i=0; i<tempArr.count; i++) {
                if (i%2 == 0) {
                    [temp1 addObject:tempArr[i]];
                    [temp11 addObject:@"toutiao"];
                }else{
                    [temp2 addObject:tempArr[i]];
                    if ([tempArr[i] isEqualToString:@""]) {
                        [temp21 addObject:@""];
                    }else{
                        [temp21 addObject:@"toutiao"];
                    }
                }
            }
            self.topTitleArr = temp1;
            self.topSignImageArr = temp11;
            self.bottomTitleArr = temp2;
            self.bottomSignImageArr = temp21;
            
            [self.tableV reloadData];
            [self.pagerView reloadData];
            self.pageControl.numberOfPages = self.model.data.bannerList.count;
        }
    });
}

-(void)requestListData{
    
    [self.paramDataDic setValue:@"0" forKey:@"type"];
    
    NSMutableDictionary *page = [NSMutableDictionary dictionary];
    [page setValue:@(_pageNum) forKey:@"currPage"];
    [page setValue:@10 forKey:@"pageSize"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[self.paramDataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:[page mj_JSONString] forKey:@"page"];
    [paramDic setObject:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appPostsSearchOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            HomeIndexListModel *model = [HomeIndexListModel mj_objectWithKeyValues:data];
            if (model.data.list.count == 0) {
                [HUD dissmissShowView:nil];
                [HUD showHUDError:nil title:@"暂无数据"];
            }
            if (_pageNum == 1) {
                self.dataSource = model.data.list;
                [self.tableV.mj_header endRefreshing];
                [self.tableV.mj_footer resetNoMoreData];
            }else{
                NSMutableArray *temp = [NSMutableArray arrayWithArray:self.dataSource];
                [temp addObjectsFromArray:model.data.list];
                self.dataSource = [temp copy];
            }
            if (model.data.isLastPage) {
                [self.tableV.mj_footer endRefreshingWithNoMoreData];
            }else{
                [self.tableV.mj_footer endRefreshing];
            }
            
            [self.tableV reloadData];
            
        }else{
            [self.tableV.mj_header endRefreshing];
            [self.tableV.mj_footer endRefreshing];
        }
    });
}
#pragma mark - action
-(void)doSearchView{
    SearchViewController *vc = [SearchViewController new];
    [self.navigationController pushViewController:vc animated:YES];
}
-(void)doMenuBtn{
    SearchResultViewController *vc = [SearchResultViewController new];
    vc.title = @"全部分类";
    [self.navigationController pushViewController:vc animated:YES];
}

-(void)doTopBtn:(UIButton *)btn{
    
    if (btn.tag == 0) {//投递进程
        MineHtmlViewController *vc = [MineHtmlViewController new];
        vc.htmlString = [NSString stringWithFormat:@"%@/app/deliveryProcess.do?token=%@",BaseServerUrl,AppDelegateInstance.token];
        [self.navigationController pushViewController:vc animated:YES];
    }
    if (btn.tag == 1) {//申请记录
        MineHtmlViewController *vc = [MineHtmlViewController new];
        vc.htmlString = [NSString stringWithFormat:@"%@/app/applyRecord.do?token=%@",BaseServerUrl,AppDelegateInstance.token];
        [self.navigationController pushViewController:vc animated:YES];
    }
    if (btn.tag == 2) {//我的收藏、关注
        MineHtmlViewController *vc = [MineHtmlViewController new];
        vc.htmlString = [NSString stringWithFormat:@"%@/app/queryAppJobList.do?token=%@",BaseServerUrl,AppDelegateInstance.token];
        [self.navigationController pushViewController:vc animated:YES];
    }
    
}
-(void)doPositionBtn:(UIButton *)btn{
    self.cityFilterV.hidden = !self.cityFilterV.hidden;
    if (self.cityFilterV.hidden == NO) {
        if (_filterCityID != 0) {
            self.cityFilterV.initCityId = _filterCityID;
        }else{
            self.cityFilterV.defautCityStr = _filterCity;
        }
        
        
        [self.cityFilterV mas_updateConstraints:^(MASConstraintMaker *make) {
            make.top.mas_offset(kNavBarHeight);
        }];
        
        self.tableV.scrollEnabled = NO;
    }else{
        self.tableV.scrollEnabled = YES;
    }
    WEAKSELF;
    _cityFilterV.citySelectedBlock = ^(NSString * _Nonnull cityStr, NSInteger cityId) {
        [weakSelf.positionBtn setTitle:cityStr forState:UIControlStateNormal];
        [weakSelf.positionBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
        _filterCityID = cityId;
        _filterCity = cityStr;
        NSLog(@"%@ -- %ld",cityStr,cityId);
        if (cityId == -1){
            [weakSelf.paramDataDic setValue:@"" forKey:@"workAddressRegion"];
        }else{
            
            [weakSelf.paramDataDic setValue:cityStr forKey:@"workAddressRegion"];
        }
        
        _pageNum = 1;
        [weakSelf requestListData];
        if (weakSelf.cityFilterV.hidden == YES) {
            weakSelf.tableV.scrollEnabled = YES;
        }
        
    };
}

-(void)doHeadViewBtn:(UIButton *)btn{
    CGRect rect = [btn convertRect:btn.frame toView:self.view];
    NSLog(@"%@",NSStringFromCGRect(rect));
    
    if ([btn isEqual:self.cityBtn]) {
        self.otherFliterV.hidden = YES;
        self.cityFilterV.hidden = !self.cityFilterV.hidden;
        
        
        if (self.cityFilterV.hidden == NO) {
            self.cityFilterV.initCityId = _filterCityID;
            
            [self.cityFilterV mas_updateConstraints:^(MASConstraintMaker *make) {
                make.top.mas_offset(rect.origin.y);
            }];
            
            self.tableV.scrollEnabled = NO;
        }else{
            self.tableV.scrollEnabled = YES;
        }
        
        WEAKSELF;
        _cityFilterV.citySelectedBlock = ^(NSString * _Nonnull cityStr, NSInteger cityId) {
            [weakSelf.cityBtn setTitle:cityStr forState:UIControlStateNormal];
            [weakSelf.cityBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleRight imageTitleSpace:Size(7)];
            _filterCityID = cityId;
            _filterCity = cityStr;
            NSLog(@"%@ -- %ld",cityStr,cityId);
            if (cityId != 0) {
                [weakSelf.paramDataDic setValue:NSStringFromInteger(cityId) forKey:@"workAddressRegionId"];
            }else{
                [weakSelf.paramDataDic setValue:@"" forKey:@"workAddressRegionId"];
            }
            
            _pageNum = 1;
            [weakSelf requestListData];
            if (weakSelf.cityFilterV.hidden == YES) {
                weakSelf.tableV.scrollEnabled = YES;
            }
            
        };
    }
    
    
    if ([btn isEqual:self.otherBtn]) {
        self.cityFilterV.hidden = YES;
        
        self.otherFliterV.hidden = !self.otherFliterV.hidden;
        if (self.otherFliterV.hidden == NO) {
            [self.otherFliterV mas_updateConstraints:^(MASConstraintMaker *make) {
                
                make.top.mas_offset(rect.origin.y);
            }];
            self.otherFliterV.hidden = NO;
            self.tableV.scrollEnabled = NO;
        }else{
            self.otherFliterV.hidden = YES;
            self.tableV.scrollEnabled = YES;
        }
        
        WEAKSELF;
        _otherFliterV.sureBtnBlock = ^(NSString * _Nonnull eduStr, NSString * _Nonnull workStr, NSString * _Nonnull salaStr, NSInteger eduID, NSInteger workID, NSInteger salaID) {
          
            NSLog(@"%@ - %ld\n%@ - %ld\n%@ - %ld",eduStr,eduID, workStr,workID, salaStr,salaID);
            weakSelf.otherFliterV.hidden = YES;
            
            [weakSelf.paramDataDic setValue:(eduID<0 ? @"" : NSStringFromInteger(eduID)) forKey:@"educationLevel"];
            [weakSelf.paramDataDic setValue:(workID<0 ? @"" : NSStringFromInteger(workID)) forKey:@"workYear"];
            [weakSelf.paramDataDic setValue:(salaID<0 ? @"" : NSStringFromInteger(salaID)) forKey:@"salaryRangeId"];
            
            _pageNum = 1;
            [weakSelf requestListData];
            
            weakSelf.tableV.scrollEnabled = YES;
        };
        
    }
    
    
    if ([btn isEqual:self.tradeBtn]) {
        self.tableV.scrollEnabled = YES;
        self.otherFliterV.hidden = YES;
        self.cityFilterV.hidden = YES;
        ChoseTradeViewController *vc = [ChoseTradeViewController new];
        vc.defaultDic = [_filterTradeDic mutableCopy];
        vc.multipleCount = 3;
        
        WEAKSELF;
        vc.tradeSelectedBlock = ^(NSDictionary * _Nonnull tradeDic) {
            
            NSLog(@"%@",tradeDic);
            _filterTradeDic = tradeDic;
            
            NSMutableArray *temp = [NSMutableArray array];
            for (Children *c in tradeDic[@"tradeArr"]) {
                [temp addObject:NSStringFromInteger(c.value)];
            }
            
            [weakSelf.paramDataDic setValue:[temp componentsJoinedByString:@","] forKey:@"industryClassId"];
//            _pageNum = 1;
//            [weakSelf requestListData];
            
        };
        [self.navigationController pushViewController:vc animated:YES];
    }
}
#pragma mark - tableView、delegate
-(UITableView *)tableV{
    if (!_tableV) {
        _tableV = [[UITableView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, kScreenHeight-kTabBarHeight) style:UITableViewStyleGrouped];
        if (@available(iOS 11.0, *)) {
            _tableV.contentInsetAdjustmentBehavior = UIScrollViewContentInsetAdjustmentNever;
        } else {
            // Fallback on earlier versions
        }
        _tableV.tableFooterView = [UIView new];
        _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
        _tableV.showsVerticalScrollIndicator = NO;
        _tableV.showsHorizontalScrollIndicator = NO;
        _tableV.backgroundColor = COLOR_BG;
        _tableV.dataSource = self;
        _tableV.delegate = self;
        
        _tableV.mj_header = [YMRefreshHeader ym_headerWithRefreshingsBlock:^{
            _pageNum = 1;
            [self requestListData];
        } animated:NO];
        
        _tableV.mj_footer = [YMRefreshFooter ym_footerWithRefreshingsBlock:^{
            _pageNum++;
            [self requestListData];
        } animated:NO];
        
        UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(128/2+278/2) + Size(166/2))];
        view.backgroundColor = RGBCOLOR(255, 255, 255);
        //UIView *view = [UIView new];
        _tableV.tableHeaderView = view;
        
        
        TYCyclePagerView *pagerView = [[TYCyclePagerView alloc]init];
        pagerView.frame = CGRectMake(0, 0, kScreenWidth,Size(128/2+278/2));
        [view addSubview:pagerView];
        self.pagerView = pagerView;
        pagerView.backgroundColor = HEXRGBCOLOR(0xf4f4f4);
        pagerView.isInfiniteLoop = YES;
        pagerView.autoScrollInterval = 3;
        pagerView.dataSource = self;
        pagerView.delegate = self;
        [pagerView registerClass:[TYCyclePagerViewCell class] forCellWithReuseIdentifier:@"TYCyclePagerViewCell"];
        
        
        
        TYPageControl *pageControl = [[TYPageControl alloc]init];
        pageControl.frame = CGRectMake(0, Size(128/2+278/2)-Size(40), kScreenWidth, Size(40));
        pageControl.pageIndicatorSize = CGSizeMake(Size(5), Size(5));
        pageControl.currentPageIndicatorSize = CGSizeMake(Size(8), Size(8));
        pageControl.pageIndicatorTintColor = HEXRGBACOLOR(0xffffff, 0.5);
        pageControl.currentPageIndicatorTintColor = HEXRGBCOLOR(0xffffff);
        [view addSubview:pageControl];
        self.pageControl = pageControl;
        self.pageControl.numberOfPages = 3;

        NSArray *arr = @[@"投递进程",@"申请记录",@"我的收藏/关注"];
        NSArray *imgArr = @[@"投递进程",@"申请记录",@"我的收藏"];
        for (int i=0; i<arr.count; i++) {
            UIButton *btn = [UIButton ym_ButtonWithFrame:CGRectMake(kScreenWidth/arr.count * i, pagerView.bottom, kScreenWidth/arr.count, Size(166/2)) title:arr[i] backgroundColor:nil titleColor:COLOR_RGB_51 titleSize:Size(12)];
            [btn setImage:[UIImage imageNamed:imgArr[i]] forState:UIControlStateNormal];
            [btn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleTop imageTitleSpace:Size(10)];
            btn.tag = i;
            [btn addTarget:self action:@selector(doTopBtn:) forControlEvents:UIControlEventTouchUpInside];
            [view addSubview:btn];
        }
    }
        
    return _tableV;
}

-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return 1;
    }
    return self.dataSource.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        CELL_DEFINE(SliderNewsTableViewCell);
        
        cell.topSignImageArr = self.topSignImageArr;
        cell.topTitleArr = self.topTitleArr;
        cell.bottomSignImageArr = self.bottomSignImageArr;
        cell.bottomTitleArr = self.bottomTitleArr;
        return cell;
    }
    CELL_DEFINE(HomeJobListTableViewCell);
    cell.model = self.dataSource[indexPath.row];
    return cell;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        return Size(150/2);
    }
    return Size(262/2+5);
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    if (section == 1) {
        UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(135/2 - 64/2))];
        view.backgroundColor = RGBCOLOR(255, 255, 255);
        
        UIButton *btn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"推荐列表" backgroundColor:nil titleColor:COLOR_RGB_51 titleSize:Size(15)];
        [btn setImage:[UIImage imageNamed:@"推荐列表"] forState:UIControlStateNormal];
        [view addSubview:btn];
        [btn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(12);
            make.top.mas_offset(Size(13));
            make.height.mas_equalTo(Size(17));
        }];
        [btn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
        /*
        UIButton *cityBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"北京" backgroundColor:nil titleColor:COLOR_RGB_153 titleSize:Size(13)];
        [view addSubview:cityBtn];
        [cityBtn setTitle:_filterCity forState:UIControlStateNormal];
        [cityBtn setImage:[UIImage imageNamed:@"附近职位-箭头"] forState:UIControlStateNormal];
        self.cityBtn = cityBtn;
        
        UIButton *tradeBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"行业" backgroundColor:nil titleColor:COLOR_RGB_153 titleSize:Size(15)];
        [view addSubview:tradeBtn];
        [tradeBtn setImage:[UIImage imageNamed:@"附近职位-箭头"] forState:UIControlStateNormal];
        self.tradeBtn = tradeBtn;
        
        UIButton *otherBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"其他" backgroundColor:nil titleColor:COLOR_RGB_153 titleSize:Size(15)];
        [view addSubview:otherBtn];
        [otherBtn setImage:[UIImage imageNamed:@"附近职位-箭头"] forState:UIControlStateNormal];
        self.otherBtn = otherBtn;
        
        NSArray *btnArr = @[cityBtn,tradeBtn,otherBtn];
        [btnArr mas_distributeViewsAlongAxis:MASAxisTypeHorizontal withFixedSpacing:0.5 leadSpacing:0 tailSpacing:0];
        [btnArr mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.mas_equalTo(btn.mas_bottom).mas_offset(Size(4));
            make.height.mas_equalTo(Size(64/2));
        }];
        
        
        [cityBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleRight imageTitleSpace:Size(7)];
        [otherBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleRight imageTitleSpace:Size(7)];
        [tradeBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleRight imageTitleSpace:Size(7)];
        [cityBtn addTarget:self action:@selector(doHeadViewBtn:) forControlEvents:UIControlEventTouchUpInside];
        [otherBtn addTarget:self action:@selector(doHeadViewBtn:) forControlEvents:UIControlEventTouchUpInside];
        [tradeBtn addTarget:self action:@selector(doHeadViewBtn:) forControlEvents:UIControlEventTouchUpInside];
        
        
        UIView *line1 = [UIView new];
        line1.backgroundColor = RGBACOLOR(153, 153, 153, 0.75);
        [view addSubview:line1];
        [line1 mas_makeConstraints:^(MASConstraintMaker *make) {
            make.width.mas_equalTo(0.5);
            make.height.mas_equalTo(Size(15));
            make.left.equalTo(cityBtn.mas_right);
            make.centerY.equalTo(cityBtn.mas_centerY);
        }];
        
        UIView *line2 = [UIView new];
        line2.backgroundColor = RGBACOLOR(153, 153, 153, 0.75);
        [view addSubview:line2];
        [line2 mas_makeConstraints:^(MASConstraintMaker *make) {
            make.width.mas_equalTo(0.5);
            make.height.mas_equalTo(Size(15));
            make.left.equalTo(tradeBtn.mas_right);
            make.centerY.equalTo(tradeBtn);
        }];
        */
        UIView *line3 = [UIView new];
        line3.backgroundColor = RGBACOLOR(153, 153, 153, 0.75);
        [view addSubview:line3];
        [line3 mas_makeConstraints:^(MASConstraintMaker *make) {
            make.height.mas_equalTo(0.5);
            make.left.right.mas_offset(0);
            make.bottom.mas_offset(-0.5);
        }];
        
        return view;
    }
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    if (section == 1) {
        return Size(135/2 - 64/2);
    }
    return CGFLOAT_MIN;
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 1) {
        JobDetailViewController *vc = [JobDetailViewController new];
        vc.postID = NSStringFromInteger(self.dataSource[indexPath.row].ID);
        vc.companyID = NSStringFromInteger(self.dataSource[indexPath.row].company_id);
        [self.navigationController pushViewController:vc animated:YES];
    }
}


#pragma mark - scroll delegate
-(void)scrollViewDidScroll:(UIScrollView *)scrollView{
    
    //计算滚动的便宜量
    CGFloat offSetY = scrollView.contentOffset.y;
    
    // 处理导航条
    // 计算当前的透明度
    CGFloat alpha = offSetY / Size(278/2);
    self.navigationController.navigationBar.barTintColor = RGBACOLOR(255, 187, 21, alpha);
    
    //NSLog(@"%f",offSetY);
    if (offSetY > Size(278/2)) {
        [self.navigationController.navigationBar setBackgroundImage:nil forBarMetrics:UIBarMetricsDefault];
    }else{
        //[self.navigationController.navigationBar setBackgroundImage:[UIImage new] forBarMetrics:UIBarMetricsDefault];
        [self.navigationController.navigationBar setBackgroundImage:[UIImage ym_imageWithColor:RGBACOLOR(255, 187, 21, alpha) size:CGSizeMake(kScreenWidth, kNavBarHeight)] forBarMetrics:UIBarMetricsDefault];
    }
    
    
    
    
    //设置标题的透明度
    //self.titleL.textColor = [UIColor colorWithWhite:0 alpha:alpha];
    
    // 获取导航条的颜色
    //UIColor *navColor = [UIColor colorWithWhite:1 alpha:alpha];
    
    // 设置导航条背景图片
    //[self.navigationController.navigationBar setBackgroundImage:[UIImage imageWithColor:navColor] forBarMetrics:UIBarMetricsDefault];
    
    
}

#pragma mark - 定位 位置 delegate
/* 定位完成后 回调 */
-(void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray<CLLocation *> *)locations{
    
    CLLocation *location = [locations lastObject];
    
    CLLocationCoordinate2D coordinate = location.coordinate;
    //  经纬度
    NSLog(@"---x:%f---y:%f",coordinate.latitude,coordinate.longitude);
    
    [manager stopUpdatingLocation];   //停止定位
    
    //根据经纬度反向地理编译出地址信息
    CLGeocoder * geoCoder = [[CLGeocoder alloc] init];
    
    [geoCoder reverseGeocodeLocation:location completionHandler:^(NSArray *placemarks, NSError *error) {
        
        for (CLPlacemark * placemark in placemarks) {
            NSLog(@"#####%@",placemark.postalCode);
            
            NSDictionary *address = [placemark addressDictionary];
            
            //  Country(国家)  State(省)  City（市）
            NSLog(@"#####%@",address);
            
            NSLog(@"%@", [address objectForKey:@"Country"]);
            
            NSLog(@"%@", [address objectForKey:@"State"]);
            
            NSLog(@"%@", [address objectForKey:@"City"]);
            
            NSLog(@"%@", [address objectForKey:@"SubLocality"]);
            
            [self.positionBtn setTitle:[address objectForKey:@"City"] forState:UIControlStateNormal];
            [self.positionBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
//            _filterCityID = self.model.data.cityId;
            _filterCity = [address objectForKey:@"City"];
            
            [self.paramDataDic setValue:[address objectForKey:@"City"] forKey:@"workAddressRegion"];
           
        }
        
        _pageNum = 1;
        [self requestListData];
        
    }];
    
    
}

/* 定位失败后 回调 */
-(void)locationManager:(CLLocationManager *)manager didFailWithError:(NSError *)error{
    
    if (error.code == kCLErrorDenied) {
        // 提示用户出错
        [HUD showHUDError:nil title:@"定位失败"];
        [self.positionBtn setTitle:@"全部" forState:UIControlStateNormal];
        [self.positionBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(5)];
        _filterCityID = -1;
        //            _filterCityID = self.model.data.cityId;
        //            _filterCity = self.model.data.city;
        
        [self.paramDataDic setValue:@"" forKey:@"workAddressRegion"];
        _pageNum = 1;
        [self requestListData];
    }
}

#pragma mark - pageView delegate
-(NSInteger)numberOfItemsInPagerView:(TYCyclePagerView *)pageView{
    return self.model.data.bannerList.count;
}

-(UICollectionViewCell *)pagerView:(TYCyclePagerView *)pagerView cellForItemAtIndex:(NSInteger)index{
    TYCyclePagerViewCell *cell = [pagerView dequeueReusableCellWithReuseIdentifier:@"TYCyclePagerViewCell" forIndex:index];
    cell.contentImage.contentMode = UIViewContentModeScaleAspectFit;
    [cell.contentImage sd_setImageWithURL:[NSURL URLWithString:self.model.data.bannerList[index].file_url] placeholderImage:[UIImage imageNamed:@"banner"]];
    //cell.contentImage.image = [UIImage imageNamed:@"banner"];
    return cell;
}
- (TYCyclePagerViewLayout *)layoutForPagerView:(TYCyclePagerView *)pageView{
    TYCyclePagerViewLayout *layout = [[TYCyclePagerViewLayout alloc]init];
    
    //layout.itemSpacing = 5;
    layout.itemSize = CGSizeMake(kScreenWidth, Size(128/2+278/2));
    layout.layoutType = TYCyclePagerTransformLayoutNormal;
    //layout.minimumAlpha = 0.3;
    layout.itemHorizontalCenter = YES;
    layout.itemVerticalCenter= NO;
    layout.adjustSpacingWhenScroling = NO;
    
    return layout;
}
- (void)pagerView:(TYCyclePagerView *)pageView didScrollFromIndex:(NSInteger)fromIndex toIndex:(NSInteger)toIndex {
    self.pageControl.currentPage = toIndex;
}

- (void)pagerView:(TYCyclePagerView *)pageView didSelectedItemCell:(__kindof UICollectionViewCell *)cell atIndex:(NSInteger)index{
    //    if (self.bannerImageClickBlock) {
    //        self.bannerImageClickBlock(index);
    //    }
}


#pragma mark - 懒加载
-(CompleteInformationAlertView *)completeInfoAlertV{
    if (!_completeInfoAlertV) {
        _completeInfoAlertV = [[CompleteInformationAlertView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, kScreenHeight)];
        _completeInfoAlertV.allStr = @"赶快去完善你的个人信息，让大家更容易发现你";
        _completeInfoAlertV.hrefStr = @"个人信息";
        _completeInfoAlertV.hidden = YES;
        [AppDelegateInstance.window addSubview:_completeInfoAlertV];
        
        WEAKSELF;
        _completeInfoAlertV.completeInfoBlock = ^{
            NSLog(@"完善个人信息");
            weakSelf.completeInfoAlertV.hidden = YES;
        };
        _completeInfoAlertV.skipBtnBlock = ^{
            _jumpInfo = YES;
        };
    }
    return _completeInfoAlertV;
}

-(EducationFilterView *)otherFliterV{
    if (!_otherFliterV) {
        _otherFliterV = [[EducationFilterView alloc]initWithFrame:CGRectZero];
        [self.view addSubview:_otherFliterV];
        [_otherFliterV mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.right.bottom.mas_offset(0);
        }];
        
        _otherFliterV.hidden = YES;
    }
    return _otherFliterV;
}
-(CityFilterView *)cityFilterV{
    if (!_cityFilterV) {
        _cityFilterV = [[CityFilterView alloc]initWithFrame:CGRectZero];
        [self.view addSubview:_cityFilterV];
        [_cityFilterV mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.right.bottom.mas_offset(0);
        }];
        
        _cityFilterV.hidden = YES;
    }
    return _cityFilterV;
}


-(NSMutableDictionary *)paramDataDic{
    if (!_paramDataDic) {
        _paramDataDic = [NSMutableDictionary dictionary];
    }
    return _paramDataDic;
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
