//
//  TreatmentEditViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/14.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "TreatmentEditViewController.h"
#import "YMTextView.h"
#import "MineInfoTableViewCell.h"
#import "CLAlertView.h"
@interface TreatmentEditViewController ()<UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate>{
    NSArray<PositionInitTCjDesCards *> *_itemArr;
}
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSMutableArray<UIButton *> *btnMuArr;

@property (nonatomic, strong) YMTextView *planTextV;
@property (nonatomic, strong) UITextField *foodTF;
@property (nonatomic, strong) UITextField *stayTF;
@property (nonatomic, strong) UITextField *socialTF;
@property (nonatomic, strong) UITextField *otherTF;

@end

@implementation TreatmentEditViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    _itemArr = self.postInitData.tCjDesCards;//@[@"三险一金",@"五险一金",@"年终奖"];
    [self initUI];
}
-(void)initUI{
    self.title = @"公司福利";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    _tableV.contentInset = UIEdgeInsetsMake(Size(10), 0, 0, 0);
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    _tableV.rowHeight = Size(120/2);
}
#pragma mark - action
-(void)doSaveItem{
    [self.view endEditing:YES];
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.postInitData.post.ID == 0 ? @"" : NSStringFromInteger(self.postInitData.post.ID) forKey:@"postId"];
    [dataDic setValue:self.postInitData.post.job_name forKey:@"jobName"];
    
    [dataDic setValue:self.postInitData.fl forKey:@"desCardIds"];
    //[dataDic setValue:[self.postInitData.post.food_situation isEqualToString:@"有"] ? @"1" : @"0" forKey:@"foodSituation"];
    //[dataDic setValue:[self.postInitData.post.bed_situation isEqualToString:@"有"] ? @"1" : @"0" forKey:@"bedSituation"];
    [dataDic setValue:self.postInitData.post.food_situation forKey:@"foodSituation"];
    [dataDic setValue:self.postInitData.post.bed_situation forKey:@"bedSituation"];
    [dataDic setValue:self.postInitData.post.social_good forKey:@"socialGood"];
    [dataDic setValue:self.postInitData.post.other_good forKey:@"otherGood"];
    [dataDic setValue:@"1" forKey:@"status"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddPostOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            if (code == 5000) {//认证通过之后未交入驻押金前为试用期,试用期只能发布3个岗位,另一种情况为非试用期,但入驻押金少于1000,同样不能发布职位,会返回5000,这时,请跳转充值页面
                [HUD showHUDError:nil title:data[@"data"]];
                return ;
            }
            [HUD showHUDError:nil title:@"已保存"];
            [self.navigationController popViewControllerAnimated:YES];
        }
    });
}
-(void)doItemBtn:(UIButton *)btn{
    btn.selected = !btn.selected;
    if (btn.selected) {
        NSMutableArray *temp = [[self.postInitData.fl componentsSeparatedByString:@","] mutableCopy];
        [temp addObject:[NSString stringWithFormat:@"%ld",btn.tag]];
        self.postInitData.fl = [temp componentsJoinedByString:@","];
    }else{
        NSMutableArray *temp = [[self.postInitData.fl componentsSeparatedByString:@","] mutableCopy];
        for (NSString *str in temp) {
            if (str.integerValue ==  btn.tag) {
                [temp removeObject:str];
                break;
            }
        }
        self.postInitData.fl = [temp componentsJoinedByString:@","];
    }
    
    [self.tableV reloadData];
}
#pragma mark - tableview deleagte
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return 1;
    }
    return 4;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(MineInfoTableViewCell);
    cell.arrowImgV.hidden = YES;
    cell.line.hidden = NO;
    [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_offset(-Size(15));
        make.centerY.equalTo(cell.contentView);
    }];
    if (indexPath.section == 0) {
        cell.titleLab.text = @"公司福利";
        cell.textF.hidden = YES;
        cell.line.hidden = YES;
    }else{
        cell.textF.hidden = NO;
        cell.textF.enabled = YES;
        switch (indexPath.row) {
            case 0:{
                cell.titleLab.text = @"餐补情况";
                cell.textF.enabled = NO;
                cell.textF.placeholder = @"请选择";
                cell.textF.text = self.postInitData.post.food_situation;
                self.foodTF = cell.textF;
            }
                break;
            case 1:{
                cell.titleLab.text = @"住宿情况";
                cell.textF.enabled = NO;
                cell.textF.placeholder = @"请选择";
                cell.textF.text = self.postInitData.post.bed_situation;
                self.stayTF = cell.textF;
            }
                break;
            case 2:{
                cell.titleLab.text = @"社保福利";
                cell.textF.placeholder = @"请填写";
                self.socialTF = cell.textF;
                self.socialTF.delegate = self;
                self.socialTF.text = self.postInitData.post.social_good;
            }
                break;
            case 3:{
                cell.titleLab.text = @"其他福利";
                cell.textF.placeholder = @"请填写";
                self.otherTF = cell.textF;
                self.otherTF.delegate = self;
                self.otherTF.text = self.postInitData.post.other_good;
            }
                break;
            default:
                break;
        }
    }
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    if (section == 0) {
        UIView *view = [UIView new];
        view.backgroundColor = RGBCOLOR(255, 255, 255);
        view.frame = CGRectMake(0, 0, kScreenWidth, Size(10) + Size(30+5)*_itemArr.count);
        CGFloat btnW = (kScreenWidth-Size(30)-Size(10)*3)/4;
        for (int i=0; i<_itemArr.count; i++) {
            UIButton *btn = [UIButton ym_ButtonWithFrame:CGRectMake(Size(15)+(btnW + Size(10))*(i%4), Size(5)+Size(30+5)*(i/4), btnW, Size(30)) title:_itemArr[i].describ backgroundColor:COLOR_BG titleColor:COLOR_RGB_51 titleSize:Size(14)];
            //            btn.layer.cornerRadius = Size(4);
            //            btn.clipsToBounds = YES;
            btn.tag = _itemArr[i].ID;
            [btn setBackgroundImage:[UIImage ym_imageWithColor:COLOR_MAIN_ENTERPRISE size:btn.size] forState:UIControlStateSelected];
            [view addSubview:btn];
            [btn addTarget:self action:@selector(doItemBtn:) forControlEvents:UIControlEventTouchUpInside];
            [self.btnMuArr addObject:btn];
            
            NSArray *idsArr = [self.postInitData.fl componentsSeparatedByString:@","];
            for (NSString *str in idsArr) {
                if (str.integerValue == _itemArr[i].ID) {
                    btn.selected = YES;
                }
            }
        }
        
        return view;
    }
    
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section == 0) {
        return Size(30+5)*(_itemArr.count%4 == 0 ? _itemArr.count/4 : _itemArr.count/4+1);
    }
    return CGFLOAT_MIN;
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [self.view endEditing:YES];
    
    MineInfoTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if ([cell.titleLab.text isEqualToString:@"餐补情况"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"餐补情况";
        alert.titleArray = @[@"有", @"无"];
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.postInitData.post.food_situation = string;
            [self.tableV reloadData];
        };
        [alert show];
    }
    if ([cell.titleLab.text isEqualToString:@"住宿情况"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"餐补情况";
        alert.titleArray = @[@"有", @"无"];
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.postInitData.post.bed_situation = string;
            [self.tableV reloadData];
        };
        [alert show];
    }
}

#pragma mark - textField delegate
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField == self.socialTF) {
        self.postInitData.post.social_good = textField.text;
    }
    if (textField == self.otherTF) {
        self.postInitData.post.other_good = textField.text;
    }
}
#pragma mark - 懒加载
-(NSMutableArray<UIButton *> *)btnMuArr{
    if (!_btnMuArr) {
        _btnMuArr = [NSMutableArray array];
    }
    return _btnMuArr;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
