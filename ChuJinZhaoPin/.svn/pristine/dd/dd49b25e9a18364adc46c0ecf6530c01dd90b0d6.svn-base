//
//  EducationExperienceViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/10.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "EducationExperienceViewController.h"
#import "MineInfoTableViewCell.h"
#import "YMTextView.h"
#import "EducationExperienceModel.h"
#import "YMDatePickerView.h"
#import "CLAlertView.h"
@interface EducationExperienceViewController ()<UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate,UITextViewDelegate>
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) UITextField *schoolTF;
@property (nonatomic, strong) UITextField *majorTF;
@property (nonatomic, strong) YMTextView *introV;

@property (nonatomic, strong) EducationExperienceModel *model;
@property (nonatomic, strong) EducationExperienceData *dataSourceM;

@end

@implementation EducationExperienceViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self initUI];
    if (self.eduId) {
        [self requestInitData];
    }else{
        self.dataSourceM = [[EducationExperienceData alloc]init];
    }
}
-(void)initUI{
    self.title = @"教育经历";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveBarItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.contentInset = UIEdgeInsetsMake(Size(10), 0, 0, 0);
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    _tableV.rowHeight = Size(120/2);
}

#pragma mark - request
-(void)requestInitData{
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.eduId forKey:@"id"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appGetResumeEduExperienceByIdOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            self.model = [EducationExperienceModel mj_objectWithKeyValues:data];
            self.dataSourceM = self.model.data;
            
            [self.tableV reloadData];
        }
    });
}
#pragma mark - action
-(void)doSaveBarItem{
    if (self.schoolTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写学校"];
        return;
    }
    if (self.dataSourceM.education_level_str.length == 0) {
        [HUD showHUDError:nil title:@"请选择学历/学位"];
        return;
    }
    if (self.dataSourceM.start_time == 0) {
        [HUD showHUDError:nil title:@"请选择开始时间"];
        return;
    }
    if (self.dataSourceM.end_time == 0) {
        [HUD showHUDError:nil title:@"请选择结束时间"];
        return;
    }
    if (self.majorTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写专业"];
        return;
    }
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.dataSourceM.ID == 0 ? @"" : NSStringFromInteger(self.dataSourceM.ID) forKey:@"id"];
    [dataDic setValue:self.resumeId forKey:@"resumeId"];
    [dataDic setValue:[[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.start_time/1000]stringWithFormat:@"yyyy-MM-dd"] forKey:@"startTime"];
    [dataDic setValue:[[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.end_time/1000]stringWithFormat:@"yyyy-MM-dd"] forKey:@"endTime"];
    [dataDic setValue:self.dataSourceM.school forKey:@"school"];
    [dataDic setValue:NSStringFromInteger(self.dataSourceM.education_level) forKey:@"educationLevel"];
    [dataDic setValue:self.dataSourceM.major forKey:@"major"];
    [dataDic setValue:self.dataSourceM.describ forKey:@"describ"];
    [dataDic setValue:@"0" forKey:@"overseasExp"];
    
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddOrEditResumeEduExperienceOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            [HUD showHUDError:nil title:@"已保存"];
            BLOCK_EXEC(self.addResumeBlock,[data valueForKey:@"data"]);
            [self.navigationController popViewControllerAnimated:YES];
        }
    });
}

#pragma mark - tableview delegate
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 1) {
        return 0;
    }
    return 5;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        CELL_DEFINE(MineInfoTableViewCell);
        cell.arrowImgV.hidden = YES;
        cell.textF.enabled = YES;
        [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_offset(-Size(15));
            make.centerY.equalTo(cell.contentView);
        }];
        
        switch (indexPath.row) {
            case 0:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*学校" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请填写";
                cell.textF.text = self.dataSourceM.school;
                self.schoolTF = cell.textF;
                self.schoolTF.delegate = self;
                return cell;
            }
                break;
            case 1:{
                cell.textF.enabled = NO;
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*学历/学位" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请选择";
                cell.textF.text = self.dataSourceM.education_level_str;
                return cell;
            }
                break;
            case 2:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*开始时间" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请选择";
                cell.textF.enabled = NO;
                if (self.dataSourceM.start_time != 0) {
                    cell.textF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.start_time/1000] stringWithFormat:@"yyyy-MM-dd"];
                }
                
                return cell;
            }
                break;
            case 3:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*结束时间" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请选择";
                cell.textF.enabled = NO;
                if (self.dataSourceM.end_time != 0) {
                    cell.textF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.end_time/1000] stringWithFormat:@"yyyy-MM-dd"];
                }
                
                return cell;
            }
                break;
            case 4:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*专业" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请填写";
                cell.textF.text = self.dataSourceM.major;
                self.majorTF = cell.textF;
                self.majorTF.delegate = self;
                return cell;
            }
                break;
            default:
                break;
        }
        
    }
    
    CELL_DEFINE(UITableViewCell);
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    if (section == 1) {
        UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(120))];
        view.backgroundColor = RGBCOLOR(255, 255, 255);
        
        UILabel *itemLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
        itemLab.text = @"专业描述";
        [view addSubview:itemLab];
        [itemLab mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(Size(15));
            make.top.mas_offset(Size(20));
        }];
        
        YMTextView *introTextV = [YMTextView new];
        introTextV.textAlignment = NSTextAlignmentLeft;
        introTextV.placeholder = @"描述在学校期间所学的专业，主要包括课程内容，毕业设计等";
        introTextV.layer.borderWidth = 0.5;
        introTextV.layer.borderColor = COLOR_RGB_line.CGColor;
        introTextV.textColor = COLOR_RGB_51;
        introTextV.font = FONT_SIZE_15;
        [view addSubview:introTextV];
        [introTextV mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(Size(15));
            make.right.mas_offset(-Size(15));
            make.top.equalTo(itemLab.mas_bottom).mas_offset(13);
            make.height.mas_equalTo(Size(120));
        }];
        self.introV = introTextV;
        self.introV.delegate = self;
        self.introV.text = self.dataSourceM.describ;
        
        return view;
    }
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section == 1) {
        return Size(120+120/2);
    }
    return Size(10);
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [self.view endEditing:YES];
    MineInfoTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if ([cell.titleLab.text isEqualToString:@"*开始时间"]) {
        YMDatePickerView *picke = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-Size(250)-kSecrityHeight width:kScreenWidth height:Size(250)+kSecrityHeight ];
        
        picke.datePickerStyle = DateStyleShowYearMonthDay;
        if (self.dataSourceM.start_time != 0) {
            [picke getNowDate:[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.start_time/1000] animated:NO];
        }
        
        picke.doneBlock = ^(NSDate *date) {
            
            self.dataSourceM.start_time = [date timeIntervalSince1970]*1000;
            [self.tableV reloadData];
        };
        [picke show];
    }
    
    if ([cell.titleLab.text isEqualToString:@"*结束时间"]) {
        YMDatePickerView *picke = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-Size(250)-kSecrityHeight width:kScreenWidth height:Size(250)+kSecrityHeight ];
        
        picke.datePickerStyle = DateStyleShowYearMonthDay;
        if (self.dataSourceM.end_time != 0) {
            [picke getNowDate:[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.end_time/1000] animated:NO];
        }
        
        picke.doneBlock = ^(NSDate *date) {
            
            self.dataSourceM.end_time = [date timeIntervalSince1970]*1000;
            [self.tableV reloadData];
        };
        [picke show];
    }
    
    if ([cell.titleLab.text isEqualToString:@"*学历/学位"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"学历/学位";
        NSMutableArray *temp = [NSMutableArray array];
        for (Scale *s in AppDelegateInstance.gloableModel.data.eduLevel) {
            [temp addObject:s.value];
        }
        alert.titleArray = temp;
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.dataSourceM.education_level_str = string;
            self.dataSourceM.education_level = AppDelegateInstance.gloableModel.data.eduLevel[index].ID;
            [self.tableV reloadData];
        };
        [alert show];
    }
}

#pragma mark - textView/textField delegate
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField == self.schoolTF) {
        self.dataSourceM.school = textField.text;
    }
    if (textField == self.majorTF) {
        self.dataSourceM.major = textField.text;
    }
}

-(void)textViewDidEndEditing:(UITextView *)textView{
    self.dataSourceM.describ = textView.text;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
