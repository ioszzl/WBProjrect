//
//  JobExperienceViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/10.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "JobExperienceViewController.h"
#import "MineInfoTableViewCell.h"
#import "YMTextView.h"
#import "JobExperienceModel.h"
#import "FilterModel.h"
#import "CLAlertView.h"
#import "ChoseTradeViewController.h"
#import "YMDatePickerView.h"
@interface JobExperienceViewController ()<UITableViewDelegate,UITableViewDataSource,UITextViewDelegate,UITextFieldDelegate>
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) JobExperienceModel *model;
@property (nonatomic, strong) JobExperienceData *dataSourecM;

@property (nonatomic, strong) NSMutableArray *scaleArr;
@property (nonatomic, strong) NSMutableArray *companyTypeArr;

@property (nonatomic, strong) UITextField *companyNameTF;
@property (nonatomic, strong) UITextField *positionTF;
@property (nonatomic, strong) UITextField *departmentTF;

@end

@implementation JobExperienceViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    [self requestChoseItemData];
    
    if (self.jobId) {
        [self requestInitData];
    }else{
        self.dataSourecM = [[JobExperienceData alloc]init];
    }
    
    
}
-(void)initUI{
    self.title = @"工作经验";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveBarItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.contentInset = UIEdgeInsetsMake(Size(10), 0, 0, 0);
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    _tableV.rowHeight = Size(120/2);
}
#pragma mark - request
-(void)requestInitData{
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.jobId forKey:@"id"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appGetResumeWorkExperienceByIdOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            self.model = [JobExperienceModel mj_objectWithKeyValues:data];
            self.dataSourecM = self.model.data;
            [self.tableV reloadData];
        }
    });
}
-(void)requestChoseItemData{
    
    for (Scale *s in AppDelegateInstance.gloableModel.data.scale) {
        [self.scaleArr addObject:s.value];
    }
    for (Scale *s in AppDelegateInstance.gloableModel.data.companyType) {
        [self.companyTypeArr addObject:s.value];
    }
    
}
#pragma mark - action
-(void)doSaveBarItem{
    if (self.companyNameTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写公司名称"];
        return;
    }
    if (self.positionTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写职位"];
        return;
    }
    if (self.departmentTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写部门"];
        return;
    }
    
    
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.dataSourecM.ID == 0 ? @"" : NSStringFromInteger(self.dataSourecM.ID) forKey:@"id"];
    
    [dataDic setValue:self.resumeId forKey:@"resumeId"];
    [dataDic setValue:self.dataSourecM.work_position forKey:@"workPosition"];
    [dataDic setValue:self.dataSourecM.work_position forKey:@"workJob"];
    [dataDic setValue:NSStringFromInteger(self.dataSourecM.work_class_id) forKey:@"workClassId"];
    [dataDic setValue:NSStringFromInteger(self.dataSourecM.scale) forKey:@"scale"];
    [dataDic setValue:NSStringFromInteger(self.dataSourecM.company_type) forKey:@"companyType"];
    [dataDic setValue:[[NSDate dateWithTimeIntervalSince1970:self.dataSourecM.start_time/1000] stringWithFormat:@"yyyy-MM-dd"] forKey:@"startTime"];
    [dataDic setValue:[[NSDate dateWithTimeIntervalSince1970:self.dataSourecM.end_time/1000] stringWithFormat:@"yyyy-MM-dd"] forKey:@"endTime"];
    [dataDic setValue:self.dataSourecM.loc_company forKey:@"locCompany"];
    [dataDic setValue:self.dataSourecM.department forKey:@"department"];
    [dataDic setValue:self.dataSourecM.work_describ forKey:@"workDescrib"];
    [dataDic setValue:self.dataSourecM.job_type forKey:@"jobType"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddOrEditResumeWorkExperienceOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            [HUD showHUDError:nil title:@"已保存"];
            BLOCK_EXEC(self.addResumeBlock,[data valueForKey:@"data"]);
            [self.navigationController popViewControllerAnimated:YES];
        }
    });
}

#pragma mark - tableview delegate
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 3;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return 3;
    }else if (section == 1){
        return 4;
    }
    return 2;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        CELL_DEFINE(MineInfoTableViewCell);
        cell.arrowImgV.hidden = YES;
        cell.textF.enabled = YES;
        [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_offset(-Size(15));
            make.centerY.equalTo(cell.contentView);
        }];
        
        switch (indexPath.row) {
            case 0:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*公司名称" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请填写";
                cell.textF.delegate = self;
                self.companyNameTF = cell.textF;
                cell.textF.text = self.dataSourecM.loc_company;
                return cell;
            }
                break;
            case 1:{
                cell.textF.enabled = NO;
                cell.titleLab.text = @"行业";
                cell.textF.placeholder = @"请选择";
                cell.textF.text = self.dataSourecM.work_class_name;
                return cell;
            }
                break;
            case 2:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*职位" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请填写";
                cell.textF.delegate = self;
                self.positionTF = cell.textF;
                cell.textF.text = self.dataSourecM.work_position;
                return cell;
            }
                break;
            default:
                break;
        }
        
    }
    if (indexPath.section == 1) {
        CELL_DEFINE(MineInfoTableViewCell,
                    [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
                        make.right.mas_offset(-Size(15));
                        make.centerY.equalTo(cell.contentView);
                    }];
                    );
        cell.arrowImgV.hidden = YES;
        cell.textF.enabled = NO;
        cell.textF.placeholder = @"请选择";
       
        switch (indexPath.row) {
            case 0:
                cell.titleLab.text = @"公司规模";
                 cell.textF.text = self.dataSourecM.scale_str;
                break;
            case 1:
                cell.titleLab.text = @"公司性质";
                cell.textF.text = self.dataSourecM.company_type_str;
                break;
            case 2:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*部门" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                cell.textF.placeholder = @"请填写";
                cell.textF.delegate = self;
                self.departmentTF = cell.textF;
                cell.textF.enabled = YES;
                cell.textF.text = self.dataSourecM.department;
            }
                break;
            case 3:
                cell.textF.placeholder = @"请选择";
                cell.titleLab.text = @"工作类型";
                if ([self.dataSourecM.job_type isEqualToString:@"0"]) {
                    cell.textF.text = @"全职";
                }else if ([self.dataSourecM.job_type isEqualToString:@"01"]){
                    cell.textF.text = @"兼职";
                }
                
                break;
            default:
                break;
        }
        return cell;
    }
    if (indexPath.section == 2) {
        CELL_DEFINE(MineInfoTableViewCell,
                    [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
                        make.right.mas_offset(-Size(15));
                        make.centerY.equalTo(cell.contentView);
                    }];
                    );
        cell.arrowImgV.hidden = YES;
        cell.textF.enabled = NO;
        cell.textF.placeholder = @"请选择";
        switch (indexPath.row) {
            case 0:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*开始时间" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                if (self.dataSourecM.start_time == 0) {
                    cell.textF.text = @"";
                }else{
                    cell.textF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourecM.start_time/1000] stringWithFormat:@"yyyy-MM-dd"];
                }
                
            }
                break;
            case 1:{
                NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*结束时间" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
                [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
                cell.titleLab.attributedText = attr;
                if (self.dataSourecM.end_time == 0) {
                    cell.textF.text = @"";
                }else{
                    cell.textF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourecM.end_time/1000] stringWithFormat:@"yyyy-MM-dd"];
                }
                
            }
                break;
            default:
                break;
        }
        return cell;
    }
    
    CELL_DEFINE(UITableViewCell);
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    if (section == 2) {
        UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(120))];
        view.backgroundColor = RGBCOLOR(255, 255, 255);
        
        UILabel *itemLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
        itemLab.text = @"工作描述";
        [view addSubview:itemLab];
        [itemLab mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(Size(15));
            make.top.mas_offset(Size(20));
        }];
        
        YMTextView *introTextV = [YMTextView new];
        introTextV.textAlignment = NSTextAlignmentLeft;
        introTextV.placeholder = @"描述你的职责范围、工作任务及取得的成就";
        introTextV.text = self.dataSourecM.work_describ;
        introTextV.delegate = self;
        introTextV.layer.borderWidth = 0.5;
        introTextV.layer.borderColor = COLOR_RGB_line.CGColor;
        introTextV.textColor = COLOR_RGB_51;
        introTextV.font = FONT_SIZE_15;
        [view addSubview:introTextV];
        [introTextV mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(Size(15));
            make.right.mas_offset(-Size(15));
            make.top.equalTo(itemLab.mas_bottom).mas_offset(13);
            make.height.mas_equalTo(Size(120));
        }];
        
        return view;
    }
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section == 2) {
        return Size(120+120/2);
    }
    return Size(10);
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [self.view endEditing:YES];
    MineInfoTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if ([cell.titleLab.text isEqualToString:@"行业"]) {
        ChoseTradeViewController *vc = [ChoseTradeViewController new];
        vc.multipleCount = 1;
        vc.tradeSelectedBlock = ^(NSDictionary * _Nonnull tradeDic) {
            NSArray *temp = tradeDic[@"tradeArr"];
            Children *c = temp[0];
            self.dataSourecM.work_class_name = c.label;
            self.dataSourecM.work_class_id = c.value;
            [self.tableV reloadData];
        };
        [self.navigationController pushViewController:vc animated:YES];
    }
    if ([cell.titleLab.text isEqualToString:@"公司规模"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"公司规模";
        alert.titleArray = self.scaleArr;
        alert.hlightString = cell.textF.text;
        alert.colorStr = COLOR_MAIN;
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.dataSourecM.scale = AppDelegateInstance.gloableModel.data.scale[index].ID;
            self.dataSourecM.scale_str = string;
            [self.tableV reloadData];
        };
        [alert show];
        
    }
    if ([cell.titleLab.text isEqualToString:@"公司性质"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"公司性质";
        alert.titleArray = self.companyTypeArr;
        alert.hlightString = cell.textF.text;
        alert.colorStr = COLOR_MAIN;
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.dataSourecM.company_type = AppDelegateInstance.gloableModel.data.companyType[index].ID;
            self.dataSourecM.company_type_str = string;
            [self.tableV reloadData];
        };
        [alert show];
        
    }
    if ([cell.titleLab.text isEqualToString:@"工作类型"]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"工作类型";
        alert.titleArray = @[@"全职",@"兼职"];
        alert.hlightString = cell.textF.text;
        alert.colorStr = COLOR_MAIN;
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.dataSourecM.job_type = index == 0 ? @"0" : @"1";
            [self.tableV reloadData];
        };
        [alert show];
        
    }
    if ([cell.titleLab.text isEqualToString:@"*开始时间"]) {
        YMDatePickerView *picke = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-Size(250)-kSecrityHeight width:kScreenWidth height:Size(250)+kSecrityHeight ];
        picke.endDay = [NSDate dateTodayString:@"yyyy-MM-dd"];
        picke.beginDay = @"1970-1-1";
        picke.datePickerStyle = DateStyleShowYearMonthDay;
        [picke getNowDate:[NSDate dateWithTimeIntervalSince1970:self.dataSourecM.start_time/1000] animated:NO];
        
        picke.doneBlock = ^(NSDate *date) {
            
            self.dataSourecM.start_time = [date timeIntervalSince1970]*1000;
            [self.tableV reloadData];
        };
        [picke show];
    }
    if ([cell.titleLab.text isEqualToString:@"*结束时间"]) {
        YMDatePickerView *picke = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-Size(250)-kSecrityHeight width:kScreenWidth height:Size(250)+kSecrityHeight ];
        
        picke.datePickerStyle = DateStyleShowYearMonthDay;
        [picke getNowDate:[NSDate dateWithTimeIntervalSince1970:self.dataSourecM.end_time/1000] animated:NO];
        
        picke.doneBlock = ^(NSDate *date) {
            
            self.dataSourecM.end_time = [date timeIntervalSince1970]*1000;
            [self.tableV reloadData];
        };
        [picke show];
    }
    
}
#pragma mark - textField Delegate
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField == self.companyNameTF) {
        self.dataSourecM.loc_company = textField.text;
    }
    if (textField == self.positionTF) {
        self.dataSourecM.work_position = textField.text;
    }
    if (textField == self.departmentTF) {
        self.dataSourecM.department = textField.text;
    }
}
#pragma mark - textView delegate
-(void)textViewDidEndEditing:(UITextView *)textView{
    self.dataSourecM.work_describ = textView.text;
}
#pragma mark - 懒加载
-(NSMutableArray *)scaleArr{
    if (!_scaleArr) {
        _scaleArr = [NSMutableArray array];
    }
    return _scaleArr;
}
-(NSMutableArray *)companyTypeArr{
    if (!_companyTypeArr) {
        _companyTypeArr = [NSMutableArray array];
    }
    return _companyTypeArr;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
