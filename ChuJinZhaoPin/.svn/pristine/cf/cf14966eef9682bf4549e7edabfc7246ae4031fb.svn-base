//
//  MessageViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/10/30.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "MessageViewController.h"
#import "ChatIndexListTableViewCell.h"
#import "ChatViewController.h"
#import "MessageListModel.h"
#import "ChatListModel.h"
#import "DBHelper.h"
@interface MessageViewController ()<UITableViewDelegate,UITableViewDataSource>
{
    NSInteger _systemPageNum;
}
@property (nonatomic, strong) UIButton *chatBtn;
@property (nonatomic, strong) UIButton *messageBtn;//系统消息

@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSArray<MessageList *> *systemDataSource;

@property (nonatomic, strong) NSArray<ChatListModel *> *chatDataSource;
@end

@implementation MessageViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    
    
    
}

-(void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    
    [self doChangeBtn:self.chatBtn];
}
-(void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    
    self.navigationController.navigationBar.hidden = YES;
    
}

-(void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
    
    self.navigationController.navigationBar.hidden = NO;
    
}
-(void)initUI{
    
    UIView *navView = [UIView new];
    navView.backgroundColor = COLOR_MAIN;
    [self.view addSubview:navView];
    [navView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.right.mas_offset(0);
        make.top.height.mas_equalTo(kNavBarHeight);
    }];
    
    UIView *navLine = [UIView new];
    navLine.backgroundColor = COLOR_RGB_line;
    [navView addSubview:navLine];
    [navLine mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.mas_offset(0);
        make.height.mas_equalTo(0.6);
    }];
    
    UIView *bgV = [UIView new];
    bgV.layer.cornerRadius = Size(5);
    bgV.layer.borderColor = COLOR_RGB_line.CGColor;
    bgV.layer.borderWidth = 0.5;
    bgV.clipsToBounds = YES;
    [navView addSubview:bgV];
    [bgV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.equalTo(navView);
        make.bottom.mas_offset(-Size(15/2));
        make.width.mas_equalTo(Size(346/2));
        make.height.mas_equalTo(Size(56/2));
    }];
    
    _chatBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"聊天" backgroundColor:nil titleColor:RGBCOLOR(255, 255, 255) titleSize:Size(14)];
    [bgV addSubview:_chatBtn];
    [_chatBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.bottom.mas_offset(0);
        make.right.mas_equalTo(bgV.mas_centerX);
    }];
    [_chatBtn setBackgroundImage:[UIImage ym_imageWithColor:RGBCOLOR(255, 255, 255) size:CGSizeMake(Size(346/4), Size(56/2))] forState:UIControlStateSelected];
    [_chatBtn setTitleColor:COLOR_RGB_51 forState:UIControlStateSelected];
    [_chatBtn addTarget:self action:@selector(doChangeBtn:) forControlEvents:UIControlEventTouchUpInside];
    _chatBtn.selected = YES;
    
    _messageBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"系统消息" backgroundColor:nil titleColor:RGBCOLOR(255, 255, 255) titleSize:Size(14)];
    [bgV addSubview:_messageBtn];
    [_messageBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.top.bottom.mas_offset(0);
        make.left.mas_equalTo(bgV.mas_centerX);
    }];
    [_messageBtn setBackgroundImage:[UIImage ym_imageWithColor:RGBCOLOR(255, 255, 255) size:CGSizeMake(Size(346/4), Size(56/2))] forState:UIControlStateSelected];
    [_messageBtn setTitleColor:COLOR_RGB_51 forState:UIControlStateSelected];
    [_messageBtn addTarget:self action:@selector(doChangeBtn:) forControlEvents:UIControlEventTouchUpInside];
    
    
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.separatorInset = UIEdgeInsetsMake(0, Size(15), 0, Size(15));
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.bottom.mas_offset(0);
        make.top.mas_offset(kNavBarHeight);
    }];
    
    _tableV.mj_header = [YMRefreshHeader ym_headerWithRefreshingsBlock:^{
        if (self.messageBtn.selected) {
            _systemPageNum = 1;
            [self requestSystemMessageList];
        }else{
            [self queryAllChatListData];
        }
        
    } animated:NO];
    _tableV.mj_footer = [YMRefreshFooter ym_footerWithRefreshingsBlock:^{
        if (self.messageBtn.selected) {
            _systemPageNum++;
            [self requestSystemMessageList];
        }else{
            [self queryAllChatListData];
        }
        
        
    } animated:NO];
    
    
}

#pragma mark - request

-(void)queryAllChatListData{
    self.chatDataSource = [[DBHelper sharedDataBase] getAllChatListRecord:AppDelegateInstance.userModel.userId];
    
    [self.tableV.mj_header endRefreshing];
    [self.tableV.mj_footer endRefreshing];
    [self.tableV reloadData];
}

-(void)requestSystemMessageList{
    NSMutableDictionary *pageDic = [NSMutableDictionary dictionary];
    [pageDic setValue:NSStringFromInteger(_systemPageNum) forKey:@"currPage"];
    [pageDic setValue:@"10" forKey:@"pageSize"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[pageDic mj_JSONString] forKey:@"page"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appSystemStationNewsOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            MessageListModel *model = [MessageListModel mj_objectWithKeyValues:data];
            if (_systemPageNum == 1) {
                self.systemDataSource = model.data.pageInfo.list;
                [self.tableV.mj_header endRefreshing];
                [self.tableV.mj_footer resetNoMoreData];
            }else{
                NSMutableArray *temp = [NSMutableArray arrayWithArray:self.systemDataSource];
                [temp addObjectsFromArray:model.data.pageInfo.list];
                self.systemDataSource = [temp copy];
            }
            if (model.data.pageInfo.isLastPage) {
                [self.tableV.mj_footer endRefreshingWithNoMoreData];
            }else{
                [self.tableV.mj_footer endRefreshing];
            }
            
            
            [self.tableV reloadData];
        }else{
           
            [self.tableV.mj_header endRefreshing];
            [self.tableV.mj_footer endRefreshing];
        }
    });
}
#pragma mark - action
-(void)doChangeBtn:(UIButton *)btn{
    btn.selected = YES;
    if ([btn isEqual:self.chatBtn]) {
        self.messageBtn.selected = NO;
        [self queryAllChatListData];
    }else{
        self.chatBtn.selected = NO;
        
        _systemPageNum = 1;
        [self requestSystemMessageList];
    }
}

#pragma mark - tableview delegate
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (self.messageBtn.selected) {
        return self.systemDataSource.count;
    }
    return self.chatDataSource.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(ChatIndexListTableViewCell);
    if (self.messageBtn.selected) {
        cell.list = self.systemDataSource[indexPath.row];
        cell.headImgV.image = [UIImage imageNamed:@"职位详情-系统通知"];
    }
    if (self.chatBtn.selected) {
        ChatListModel *list = self.chatDataSource[indexPath.row];
        [cell.headImgV sd_setImageWithURL:[NSURL URLWithString:list.headUrl] placeholderImage:[UIImage imageNamed:@"头像"]];
        cell.nameLab.text = list.nick_name;//@"好未来";
        cell.contentLab.text = list.message;//@"x聊天吗x聊天吗x聊天吗x聊天吗x聊天吗x聊天吗？x聊天吗x聊天吗x聊天吗x聊天吗";
        cell.dateLab.text = [[NSDate dateWithTimeIntervalSince1970:list.creat_time/1000] stringWithFormat:@"MM-dd HH:MM"];//@"7-17 10:20";
        
    }
    return cell;
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    return [UIView new];
}
-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    return [UIView new];
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return CGFLOAT_MIN;
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (self.chatBtn.selected) {
        ChatListModel *list = self.chatDataSource[indexPath.row];
        ChatViewController *vc = [ChatViewController new];
        vc.sendId = list.otherId;
        [self.navigationController pushViewController:vc animated:YES];
    }
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
