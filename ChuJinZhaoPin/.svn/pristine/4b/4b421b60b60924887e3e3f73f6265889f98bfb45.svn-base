//
//  InterviewNoteNoticeViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/13.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "InterviewNoteNoticeViewController.h"
#import "MineInfoTableViewCell.h"
#import "YMTextView.h"
#import "ZLDatePickerView.h"
#import "CLAlertView.h"
@interface InterviewNoteNoticeViewController ()<UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate,UITextViewDelegate>
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) UILabel *positionLab;
@property (nonatomic, strong) UILabel *phoenLab;
@property (nonatomic, strong) UILabel *nameLab;
@property (nonatomic, strong) YMTextView *contentTextV;

@property (nonatomic, strong) UITextField *addressTF;
@property (nonatomic, strong) NSString *interviewTime;
@property (nonatomic, strong) NSString *interviewAddress;
@property (nonatomic, strong) NSString *contact;
@property (nonatomic, strong) NSString *contactPhone;
@property (nonatomic, strong) NSString *interviewMsg;

@property (nonatomic, strong) UIButton *emailBtn;
@property (nonatomic, strong) UIButton *messageBtn;
@end

@implementation InterviewNoteNoticeViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
}
-(void)initUI{
    self.title = @"面试通知";
    
   
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    _tableV.separatorInset = UIEdgeInsetsMake(0, Size(10), 0, 0);
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    
}
-(void)setModel:(InterviewInitModel *)model{
    _model = model;
    
    self.interviewAddress = model.data.company_address;
    self.interviewTime = @"";
    self.contact = @"";
    self.contactPhone = @"";
    self.interviewMsg = model.data.msgModel;
}
#pragma mark - action
-(void)doMessageBtn:(UIButton *)btn{
    btn.selected = !btn.selected;
}
-(void)doEmailBtn:(UIButton *)btn{
    btn.selected = !btn.selected;
}
-(void)doSureBtn{
    if (self.interviewTime.length == 0) {
        [HUD showHUDError:nil title:@"请选择面试时间"];
        return;
    }
    if (self.contact.length == 0) {
        [HUD showHUDError:nil title:@"请选择联系人"];
        return;
    }
    if (self.interviewMsg.length == 0) {
        [HUD showHUDError:nil title:@"请填写面试通知信息"];
        return;
    }
    if (self.emailBtn.selected == NO && self.messageBtn.selected == NO) {
        [HUD showHUDError:nil title:@"请选择通知方式"];
        return;
    }
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:NSStringFromInteger(self.model.data.metId) forKey:@"mettingId"];
    [dataDic setValue:[NSString stringWithFormat:@"%@:00",self.interviewTime] forKey:@"mettingDate"];
    [dataDic setValue:self.interviewAddress forKey:@"facePlace"];
    [dataDic setValue:self.contact forKey:@"facePeopleName"];
    [dataDic setValue:self.contactPhone forKey:@"facePeoplePhone"];
    [dataDic setValue:self.emailBtn.selected ? @"1" : @"0" forKey:@"isChoiceEmail"];
    [dataDic setValue:self.messageBtn.selected ? @"1" : @"0" forKey:@"isChoiceMsg"];
    [dataDic setValue:self.interviewMsg forKey:@"inviteMsg"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appInviteMettingOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            [HUD showHUDError:nil title:@"已通知"];
        }
    });
}

#pragma mark - tableview delegate

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return 4;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(MineInfoTableViewCell);
    cell.arrowImgV.hidden = YES;
    cell.textF.enabled = NO;
    cell.textF.adjustsFontSizeToFitWidth = YES;
    cell.textF.minimumFontSize = 0.5;
    [cell.textF mas_remakeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_offset(-Size(15));
        make.centerY.equalTo(cell.contentView);
        make.left.mas_greaterThanOrEqualTo(cell.titleLab.mas_right);
    }];
    
    switch (indexPath.row) {
        case 0:{
            
            cell.titleLab.text = @"面试时间：";
            cell.textF.placeholder = @"请选择";
            cell.textF.text = self.interviewTime;
        }
            break;
        case 1:{
            cell.titleLab.text = @"面试地址：";
            cell.textF.enabled = YES;
            cell.textF.text = self.interviewAddress;//@"北京市海淀区";
            self.addressTF = cell.textF;
            self.addressTF.delegate = self;
        }
            break;
        case 2:{
            cell.titleLab.text = @"联系人：";
            cell.textF.placeholder = @"请选择";
            cell.textF.text = self.contact;
        }
            break;
        case 3:{
            cell.titleLab.text = @"联系电话：";
            cell.textF.text = self.contactPhone;
        }
            break;
        default:
            break;
    }
    return cell;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return Size(120/2);
}
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(260/2))];
    UIView *bgV = [UIView new];
    bgV.backgroundColor = RGBCOLOR(255, 255, 255);
    bgV.layer.cornerRadius = Size(4);
    [view addSubview:bgV];
    [bgV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.mas_offset(Size(15));
        make.bottom.right.mas_offset(-Size(15));
    }];
    
    UILabel *nameItemLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    nameItemLab.text = @"求职者姓名：";
    [bgV addSubview:nameItemLab];
    [nameItemLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.top.mas_offset(Size(52/2));
    }];
    _nameLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_102];
    [bgV addSubview:_nameLab];
    [_nameLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(nameItemLab.mas_right);
        make.centerY.equalTo(nameItemLab);
    }];
    _nameLab.text = self.model.data.interviewUserName;//@"陈晓名";
    
    UILabel *phoneItemLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    phoneItemLab.text = @"电话：";
    [bgV addSubview:phoneItemLab];
    [phoneItemLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(406/2 - 15));
        make.top.mas_offset(Size(52/2));
    }];
    _phoenLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_102];
    [bgV addSubview:_phoenLab];
    [_phoenLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(phoneItemLab.mas_right);
        make.centerY.equalTo(phoneItemLab);
    }];
    _phoenLab.text = self.model.data.interviewUserPhone;//@"13100000000";
    
    UILabel *positionItemLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    positionItemLab.text = @"投递岗位：";
    [bgV addSubview:positionItemLab];
    [positionItemLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.top.equalTo(nameItemLab.mas_bottom).mas_offset(Size(40/2));
    }];
    _positionLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_102];
    [bgV addSubview:_positionLab];
    [_positionLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.equalTo(positionItemLab.mas_right);
        make.centerY.equalTo(positionItemLab);
    }];
    _positionLab.text = self.model.data.jobName;//@"产品经理";
    return view;
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return Size(260/2);
}

-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, Size(686/2))];
    
    UIView *bgV = [UIView new];
    bgV.backgroundColor = RGBCOLOR(255, 255, 255);
    bgV.layer.borderColor = COLOR_RGB_line.CGColor;
    bgV.layer.borderWidth = 0.5;
    [view addSubview:bgV];
    [bgV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_offset(Size(10));
        make.left.right.mas_offset(0);
        make.height.mas_equalTo(Size(279/2));
    }];
    UILabel *lab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    lab.text = @"短信内容";
    [bgV addSubview:lab];
    [lab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.top.mas_offset(Size(23));
    }];
    _contentTextV = [YMTextView new];
    _contentTextV.text = self.interviewMsg;//@"您的简历通过了HR的k审核，现通知您来面试，请提前10分钟到达面试地点，谢谢！";
    _contentTextV.font = [UIFont systemFontOfSize:Size(14)];
    _contentTextV.textColor = COLOR_RGB_51;
    _contentTextV.delegate = self;
    [bgV addSubview:_contentTextV];
    [_contentTextV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.top.equalTo(lab.mas_bottom).mas_offset(Size(14));
        make.right.mas_offset(-Size(15));
        make.bottom.mas_offset(-Size(20));
    }];
    
    UIButton *messageBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"同时发送短信" backgroundColor:nil titleColor:COLOR_RGB_102 titleSize:Size(14)];
    [messageBtn setImage:[UIImage imageNamed:@"no"] forState:UIControlStateNormal];
    [messageBtn setImage:[UIImage imageNamed:@"yes"] forState:UIControlStateSelected];
    [view addSubview:messageBtn];
    [messageBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(bgV.mas_bottom).mas_offset(Size(20));
        make.left.mas_offset(Size(40));
    }];
    self.messageBtn = messageBtn;
    [messageBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(12)];
    [messageBtn addTarget:self action:@selector(doMessageBtn:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *emailBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"同时发送邮件" backgroundColor:nil titleColor:COLOR_RGB_102 titleSize:Size(14)];
    [emailBtn setImage:[UIImage imageNamed:@"no"] forState:UIControlStateNormal];
    [emailBtn setImage:[UIImage imageNamed:@"yes"] forState:UIControlStateSelected];
    [view addSubview:emailBtn];
    [emailBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(bgV.mas_bottom).mas_offset(Size(20));
        make.right.mas_offset(-Size(40));
    }];
    self.emailBtn = emailBtn;
    [emailBtn ym_layoutButtonWithEdgeInsetsStyle:MKButtonEdgeInsetsStyleLeft imageTitleSpace:Size(12)];
    [emailBtn addTarget:self action:@selector(doEmailBtn:) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *nextBtn = [UIButton ym_ButtonWithFrame:CGRectZero title:@"确定" backgroundColor:COLOR_MAIN_ENTERPRISE titleColor:RGBCOLOR(255, 255, 255) titleSize:Size(17)];
    nextBtn.layer.cornerRadius = Size(5);
    [view addSubview:nextBtn];
    [nextBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.width.mas_equalTo(kScreenWidth-Size(30));
        make.top.equalTo(messageBtn.mas_bottom).mas_offset(Size(50));
        make.height.mas_equalTo(Size(98/2));
    }];
    [nextBtn addTarget:self action:@selector(doSureBtn) forControlEvents:UIControlEventTouchUpInside];
    
    
    return view;
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return Size(686/2);
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    MineInfoTableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if ([cell.titleLab.text isEqualToString:@"面试时间："]) {
        ZLDatePickerView *pick = [[ZLDatePickerView alloc]initWithUI:0 y:kScreenHeight-250 width:kScreenWidth height:250];
        pick.datePickerStyle = DateStyleShowYearMonthDayHourMinute;
        pick.doneBlock = ^(NSDate * _Nonnull date) {
            self.interviewTime = [date stringWithFormat:@"yyyy-MM-dd HH:mm"];
            [self.tableV reloadData];
        };
        [pick show];
        
    }
    
    if ([cell.titleLab.text isEqualToString:@"联系人："]) {
        CLAlertView *alert = [CLAlertView globeBottomView];
        alert.title = @"联系人";
        NSMutableArray *temp = [NSMutableArray array];
        for (InterviewInitContactsList *l in self.model.data.contactsList) {
            [temp addObject:l.userName];
        }
        alert.titleArray = temp;
        
        alert.globeBottomView = ^(NSInteger index, NSString *string) {
            self.contact = string;
            self.contactPhone = self.model.data.contactsList[index].phone;
            [self.tableV reloadData];
        };
        [alert show];
        
        
    }
}

#pragma mark - textView/textField delegate
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField == self.addressTF) {
        self.interviewAddress = textField.text;
    }
}

-(void)textViewDidEndEditing:(UITextView *)textView{
    
    self.interviewMsg = textView.text;
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
