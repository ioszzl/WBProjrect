//
//  CompanyMessageViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/13.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "CompanyMessageViewController.h"
#import "ChatIndexListTableViewCell.h"
#import "ChatViewController.h"
#import "MessageListModel.h"
#import "DBHelper.h"
#import "ChatListModel.h"
@interface CompanyMessageViewController ()<UITableViewDelegate,UITableViewDataSource>{
    NSInteger _pageNum;
}
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSArray<MessageList *> *systemDataSource;
@property (nonatomic, strong) NSArray<ChatListModel *> *chatDataSource;

@property (nonatomic, strong) NSMutableArray<UIButton *> *topBtnArr;
@property (nonatomic, strong) UIView *btnLine;
@property (nonatomic, strong) UIView *chatUnRead;
@property (nonatomic, strong) UIView *mesUnRead;
@end


@implementation CompanyMessageViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [self initUI];
    
    [self requestSystemMesListData];
    [self queryAllChatListData];
}
-(void)initUI{
    self.title = @"消息";
    
    UIView *topView = [UIView new];
    topView.backgroundColor = RGBCOLOR(255, 255, 255);
    topView.layer.borderColor = COLOR_RGB_line.CGColor;
    topView.layer.borderWidth = 0.5;
    [self.view addSubview:topView];
    [topView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.right.mas_offset(0);
        make.height.mas_equalTo(Size(50));
    }];
    
    NSArray *arr = @[@"聊天",@"系统消息"];
    for (int i=0; i<arr.count; i++) {
        UIButton *btn = [UIButton ym_ButtonWithFrame:CGRectZero title:arr[i] backgroundColor:nil titleColor:COLOR_RGB_51 titleSize:Size(15)];
        [btn setTitleColor:COLOR_MAIN_ENTERPRISE forState:UIControlStateSelected];
        [topView addSubview:btn];
        [btn mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_offset(kScreenWidth/arr.count*i);
            make.top.bottom.mas_offset(0);
            make.width.mas_equalTo(kScreenWidth/arr.count);
        }];
        [self.topBtnArr addObject:btn];
        [btn addTarget:self action:@selector(doTopBtn:) forControlEvents:UIControlEventTouchUpInside];
        
        UIView *redPoint = [UIView new];
        redPoint.layer.cornerRadius = Size(3);
        redPoint.clipsToBounds = YES;
        redPoint.backgroundColor = [UIColor redColor];
        [topView addSubview:redPoint];
        if ( i==0 ) {
            btn.selected = YES;
            self.chatUnRead = redPoint;
            self.chatUnRead.hidden = YES;
            [redPoint mas_makeConstraints:^(MASConstraintMaker *make) {
                make.left.mas_offset(Size(232/2));
                make.top.mas_offset(Size(10));
                make.height.width.mas_equalTo(Size(6));
            }];
        }else{
            self.mesUnRead = redPoint;
            self.mesUnRead.hidden = YES;
            [redPoint mas_makeConstraints:^(MASConstraintMaker *make) {
                make.right.mas_offset(-Size(102/2));
                make.top.mas_offset(Size(10));
                make.height.width.mas_equalTo(Size(6));
            }];
        }
    }
    
    _btnLine = [UIView new];
    _btnLine.backgroundColor = COLOR_MAIN_ENTERPRISE;
    [topView addSubview:_btnLine];
    [_btnLine mas_makeConstraints:^(MASConstraintMaker *make) {
        make.bottom.equalTo(topView);
        make.width.mas_equalTo(Size(130/2));
        make.height.mas_equalTo(1);
        make.centerX.equalTo(self.topBtnArr.firstObject);
    }];
    
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStylePlain];
    _tableV.tableFooterView = [UIView new];
    _tableV.separatorInset = UIEdgeInsetsMake(0, Size(10), 0, Size(10));
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_BG;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    _tableV.contentInset = UIEdgeInsetsMake(Size(5), 0, 0, 0);
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(topView.mas_bottom);
        make.left.right.bottom.mas_offset(0);
    }];
    
    _tableV.mj_header = [YMRefreshHeader ym_headerWithRefreshingsBlock:^{
        if (self.topBtnArr[1].selected) {
            _pageNum = 1;
            [self requestSystemMesListData];
        }else{
            [self queryAllChatListData];
        }
        
    } animated:NO];
    _tableV.mj_footer = [YMRefreshFooter ym_footerWithRefreshingsBlock:^{
        if (self.topBtnArr[1].selected) {
            _pageNum++;
            [self requestSystemMesListData];
        }else{
            [self queryAllChatListData];
        }
        
    } animated:NO];
}
#pragma mark - request
-(void)queryAllChatListData{
    self.chatDataSource = [[DBHelper sharedDataBase] getAllChatListRecord:AppDelegateInstance.userModel.userId];
    
    [self.tableV.mj_header endRefreshing];
    [self.tableV.mj_footer endRefreshing];
    [self.tableV reloadData];
}


-(void)requestSystemMesListData{
    NSMutableDictionary *pageDic = [NSMutableDictionary dictionary];
    [pageDic setValue:NSStringFromInteger(_pageNum) forKey:@"currPage"];
    [pageDic setValue:@"10" forKey:@"pageSize"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[pageDic mj_JSONString] forKey:@"page"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appCompanyStationNewsOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            MessageListModel *model = [MessageListModel mj_objectWithKeyValues:data];
            if (model.data.status == 1) {
                self.mesUnRead.hidden = NO;
            }else{
                self.mesUnRead.hidden = YES;
            }
            if (_pageNum == 1) {
                self.systemDataSource = model.data.pageInfo.list;
                [self.tableV.mj_header endRefreshing];
                [self.tableV.mj_footer resetNoMoreData];
            }else{
                NSMutableArray *temp = [NSMutableArray arrayWithArray:self.systemDataSource];
                [temp addObjectsFromArray:model.data.pageInfo.list];
                self.systemDataSource = [temp copy];
            }
            if (model.data.pageInfo.isLastPage) {
                [self.tableV.mj_footer endRefreshingWithNoMoreData];
            }else{
                [self.tableV.mj_footer endRefreshing];
            }
            
            
            [self.tableV reloadData];
        }else{
            
            [self.tableV.mj_header endRefreshing];
            [self.tableV.mj_footer endRefreshing];
        }
    });
}
#pragma mark - action
-(void)doTopBtn:(UIButton *)btn{
    for (UIButton *btt in self.topBtnArr) {
        btt.selected = NO;
    }
    btn.selected = YES;
    
    [UIView animateWithDuration:.2f animations:^{
        self.btnLine.centerX = btn.centerX;
    }];
    if (btn == self.topBtnArr[1]) {//系统
        _pageNum = 1;
        [self requestSystemMesListData];
    }else{
        [self queryAllChatListData];
    }
    
    [self.tableV reloadData];
}

#pragma mark - tableview delegate
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (self.topBtnArr[1].selected) {//系统消息
        return self.systemDataSource.count;
    }
    return self.chatDataSource.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(ChatIndexListTableViewCell);
    if (self.topBtnArr[1].selected) {//系统消息
        cell.list = self.systemDataSource[indexPath.row];
        cell.headImgV.image = [UIImage imageNamed:@"职位详情-系统通知"];
    }else{
        ChatListModel *list = self.chatDataSource[indexPath.row];
        [cell.headImgV sd_setImageWithURL:[NSURL URLWithString:list.headUrl] placeholderImage:[UIImage imageNamed:@"头像"]];
        cell.nameLab.text = list.nick_name;//@"好未来";
        cell.contentLab.text = list.message;//@"x聊天吗x聊天吗x聊天吗x聊天吗x聊天吗x聊天吗？x聊天吗x聊天吗x聊天吗x聊天吗";
        cell.dateLab.text = [[NSDate dateWithTimeIntervalSince1970:list.creat_time/1000] stringWithFormat:@"MM-dd HH:MM"];//@"7-17 10:20";
    }
    
    return cell;
    
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (self.topBtnArr[1].selected) {
        if (self.systemDataSource[indexPath.row].status == 0) {
            NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
            [dataDic setValue:NSStringFromInteger(self.systemDataSource[indexPath.row].ID) forKey:@"id"];
            [dataDic setValue:@"0" forKey:@"type"];//(0:标为已读,1删除)
            
            NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
            [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
            [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
            
            [[RHNetAPIManager sharedManager]appUpdateMsgOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
                if (data) {
                    self.systemDataSource[indexPath.row].status = 1;
                    [self.tableV reloadData];
                }
            });
        }
        
    }
    if (self.topBtnArr[0].selected) {//聊天
        ChatListModel *list = self.chatDataSource[indexPath.row];
        ChatViewController *vc = [ChatViewController new];
        vc.sendId = list.otherId;
        [self.navigationController pushViewController:vc animated:YES];
    }
    
}
#pragma mark - 懒加载
-(NSMutableArray<UIButton *> *)topBtnArr{
    if (!_topBtnArr) {
        _topBtnArr = [NSMutableArray array];
    }
    return _topBtnArr;
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
