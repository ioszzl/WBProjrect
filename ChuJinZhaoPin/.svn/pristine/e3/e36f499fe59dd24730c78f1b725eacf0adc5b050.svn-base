//
//  MineHtmlViewController.m
//  MaShangYin
//
//  Created by eims on 2018/5/11.
//  Copyright © 2018年 Monster. All rights reserved.
//

#import "MineHtmlViewController.h"
#import "WKWebView+JS.h"
#import "WKDelegateViewController.h"
#import "MainTabBarController.h"
#import "JobDetailViewController.h"
//#import <JavaScriptCore/JavaScriptCore.h>
@interface MineHtmlViewController ()<WKNavigationDelegate,WKUIDelegate,WKDelegate>
@property (nonatomic,strong)WKWebView *webView;
@property (nonatomic, strong) WKUserContentController *userContentController;
@property (nonatomic, strong) UIView *navView;

@property (nonatomic, strong) WKDelegateViewController * delegateController;
@end

@implementation MineHtmlViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self.view addSubview:self.webView];

    self.view.backgroundColor = [UIColor whiteColor];
    
    [self.webView loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:self.htmlString]]];
    
    self.navView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kScreenWidth, 44)];
    if (@available(iOS 11.0, *)) {
        
    }
    else {
        self.navView.top = 20;
    }
    self.navView.backgroundColor = RGBCOLOR(255, 255, 255);
    [self.webView addSubview:self.navView];
    UIButton *backBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    [backBtn setImage:[UIImage imageNamed:@"nav_right"] forState:UIControlStateNormal];
    [backBtn addTarget:self action:@selector(doBackBtn) forControlEvents:UIControlEventTouchUpInside];
    backBtn.frame = CGRectMake(Size(18), 14, Size(9),15);
    [backBtn ym_setEnlargeEdgeWithTop:13 right:15 bottom:14 left:15];
    [self.navView addSubview:backBtn];

    
    
}
//window.webkit.messageHandlers.<name>.postMessage(<messageBody>)
//window.webkit.messageHandlers.Share.postMessage(<messageBody>)
//messageBody是一个键值对，键是body，值可以有多种类型的参数。
//window.webkit.messageHandlers.Share.postMessage({title:'测试分享的标题',content:'测试分享的内容',url:'http://www.baidu.com'})
//window.webkit.messageHandlers.PlaySound.postMessage('shake_sound_male.wav');
//window.webkit.messageHandlers.Color.postMessage([67,205,128,0.5]);
-(WKWebView *)webView{
    if (!_webView) {
        WKWebViewConfiguration * configuration = [[WKWebViewConfiguration alloc]init];
        _userContentController =[[WKUserContentController alloc]init];
        configuration.userContentController = _userContentController;
        _webView = [[WKWebView alloc]initWithFrame:CGRectMake(0, kStatusHeight, kScreenWidth, kScreenHeight-kStatusHeight) configuration:configuration];
        //注册方法
        self.delegateController = [[WKDelegateViewController alloc]init];
        self.delegateController.delegate = self;
        _webView.navigationDelegate = self;
        _webView.UIDelegate = self;
        //注册方法
        
        [_userContentController addScriptMessageHandler:self.delegateController  name:@"onFinish"];
        
        [_userContentController addScriptMessageHandler:self.delegateController  name:@"onChange"];
        
        [_userContentController addScriptMessageHandler:self.delegateController  name:@"onLogout"];
        
        [_userContentController addScriptMessageHandler:self.delegateController  name:@"toPositionDetail"];
//        <input type="file" class="upfiles" @change="upFile" accept="image/png,image/gif,image/jpeg">
        [_webView addObserver:self forKeyPath:@"estimatedProgress" options:NSKeyValueObservingOptionNew context:nil];
    }
    return _webView;
}
-(void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSKeyValueChangeKey,id> *)change context:(void *)context{
    if ([keyPath isEqualToString:@"estimatedProgress"]) {
        if (self.webView.estimatedProgress == 1) {
            //self.navView.hidden = YES;
        }
        
        //NSLog(@".....%lf",self.webView.estimatedProgress);
    }
    else{
        [super observeValueForKeyPath:keyPath ofObject:object change:change context:context];
    }
}


-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    self.navigationController.navigationBarHidden = YES;
    [UIApplication sharedApplication].statusBarStyle = UIStatusBarStyleDefault;
}
-(void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    self.navigationController.navigationBarHidden = NO;
    [UIApplication sharedApplication].statusBarStyle = UIStatusBarStyleLightContent;
}
#pragma mark - WKDelegate (WKScriptMessageHandler)
- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message{
    NSLog(@"name:%@\n body:%@\n frameInfo:%@\n",message.name,message.body,message.frameInfo);
    if ([message.name isEqualToString:@"onFinish"]) {//导航返回
        
        [self.navigationController popViewControllerAnimated:YES];
       
    }
    if ([message.name isEqualToString:@"toPositionDetail"]) {
        NSDictionary *dic = message.body;
        NSLog(@"%@",dic);
        JobDetailViewController *vc = [JobDetailViewController new];
        vc.postID = dic[@"id"];
        vc.companyID = dic[@"companyId"];
        [self.navigationController pushViewController:vc animated:YES];
        
    }
    if ([message.name isEqualToString:@"onChange"]) {
        
        
        if ([message.body integerValue] == 0) {//求职
            AppDelegateInstance.userType = 0;
            DefaultsSetInteger(0, KEY_USER_TYPE);
            MainTabBarController *vc = [MainTabBarController new];
            AppDelegateInstance.window.rootViewController = vc;
        }
        if ([message.body  integerValue] == 1) {//企业
            AppDelegateInstance.userType = 1;
            DefaultsSetInteger(1, KEY_USER_TYPE);
            MainTabBarController *vc = [MainTabBarController new];
            AppDelegateInstance.window.rootViewController = vc;
        }
        if ([message.body integerValue] == 2) {//企业认证
            AppDelegateInstance.userType = 1;
            DefaultsSetInteger(1, KEY_USER_TYPE);
            AppDelegateInstance.userModel.loginCode = 2;
            DefaultsSetObject([AppDelegateInstance.userModel mj_JSONString], KEY_USER_DATA);
            
            MainTabBarController *vc = [MainTabBarController new];
            AppDelegateInstance.window.rootViewController = vc;
        }
        if ([message.body integerValue] == 3) {//企业信息认证
            AppDelegateInstance.userType = 1;
            DefaultsSetInteger(1, KEY_USER_TYPE);
            AppDelegateInstance.userModel.loginCode = 3;
            DefaultsSetObject([AppDelegateInstance.userModel mj_JSONString], KEY_USER_DATA);
            
            MainTabBarController *vc = [MainTabBarController new];
            AppDelegateInstance.window.rootViewController = vc;
        }
        
    }
    
    
}
#pragma mark - WKNavigationDelegate
// 页面开始加载时调用
- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(WKNavigation *)navigation{
    
}
// 当内容开始返回时调用
- (void)webView:(WKWebView *)webView didCommitNavigation:(WKNavigation *)navigation{
    
}
// 页面加载完成之后调用
- (void)webView:(WKWebView *)webView didFinishNavigation:(WKNavigation *)navigation{
    self.navView.hidden = YES;
    NSLog(@"加载完成。。%lf",webView.estimatedProgress);
    [self.webView evaluateJavaScript:@"document.documentElement.style.webkitTouchCallout='none';" completionHandler:nil];
    [self.webView evaluateJavaScript:@"document.documentElement.style.webkitUserSelect='none';"completionHandler:nil];
    self.webView.allowsLinkPreview = NO;
}
// 页面加载失败时调用
-(void)webView:(WKWebView *)webView didFailNavigation:(WKNavigation *)navigation withError:(NSError *)error{
    NSLog(@"加载失败。....。%lf",webView.estimatedProgress);
}
- (void)webView:(WKWebView *)webView didFailProvisionalNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)error {
    NSLog(@"加载失败。。%lf",webView.estimatedProgress);
    [HUD showHUDError:nil title:@"加载失败"];
}

// 接收到服务器跳转请求之后调用
- (void)webView:(WKWebView *)webView didReceiveServerRedirectForProvisionalNavigation:(WKNavigation *)navigation{
    
}
- (void)webViewWebContentProcessDidTerminate:(WKWebView *)webView{
    
}
// 在收到响应后，决定是否跳转
- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler{
    
    NSLog(@"aaa-%@",navigationResponse.response.URL.absoluteString);
    //允许跳转
    decisionHandler(WKNavigationResponsePolicyAllow);
    //不允许跳转
    //decisionHandler(WKNavigationResponsePolicyCancel);
}
// 在发送请求之前，决定是否跳转
- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler{
    
    NSLog(@"bbb-%@",navigationAction.request.URL.absoluteString);
    //允许跳转
    decisionHandler(WKNavigationActionPolicyAllow);
    //不允许跳转
    //decisionHandler(WKNavigationActionPolicyCancel);
}

#pragma mark - WKUIDelegate
// 创建一个新的WebView
//- (WKWebView *)webView:(WKWebView *)webView createWebViewWithConfiguration:(WKWebViewConfiguration *)configuration forNavigationAction:(WKNavigationAction *)navigationAction windowFeatures:(WKWindowFeatures *)windowFeatures{
//    return [[WKWebView alloc]init];
//}
// 输入框
- (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * __nullable result))completionHandler{
    completionHandler(@"https");
}
// 确认框
- (void)webView:(WKWebView *)webView runJavaScriptConfirmPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(BOOL result))completionHandler{
    
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@"提示" message:message?:@"" preferredStyle:UIAlertControllerStyleAlert];
    [alertController addAction:([UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
        completionHandler(NO);
    }])];
    [alertController addAction:([UIAlertAction actionWithTitle:@"确认" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        completionHandler(YES);
    }])];
    [self presentViewController:alertController animated:YES completion:nil];
    
    //completionHandler(YES);
}
// 警告框
- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler{
    NSLog(@"%@",message);
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:nil message:message?:@"" preferredStyle:UIAlertControllerStyleAlert];
    [alertController addAction:([UIAlertAction actionWithTitle:@"确认" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        completionHandler();
    }])];
    [self presentViewController:alertController animated:YES completion:nil];
   
    //completionHandler();
}


#pragma mark - dealloc
- (void)dealloc{
    self.delegateController.delegate = nil;
    //这里需要注意，前面增加过的方法一定要remove掉。
    [self.userContentController removeScriptMessageHandlerForName:@"onFinish"];
    [self.userContentController removeScriptMessageHandlerForName:@"onChange"];
    [self.userContentController removeScriptMessageHandlerForName:@"toPositionDetail"];
    [self.userContentController removeScriptMessageHandlerForName:@"onLogout"];
    
    [_webView removeObserver:self forKeyPath:@"estimatedProgress"];
    
}
-(void)doBackBtn{
    
    [self.navigationController popViewControllerAnimated:YES];

}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
