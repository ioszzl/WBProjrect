//
//  MineResumeListViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/8.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "MineResumeListViewController.h"
#import "MineResumeTableViewCell.h"
#import "AddResumeViewController.h"
#import "MineResumeListModel.h"
@interface MineResumeListViewController ()<UITableViewDelegate,UITableViewDataSource>{
    NSInteger _pageNum;
}
@property (nonatomic, strong) UITableView *tableV;
@property (nonatomic, strong) NSArray<MineResumeList *> *dataSource;
@end

@implementation MineResumeListViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    //self.tableV.hidden = YES;
}
-(void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    
    _pageNum = 1;
    [self requestResumeListData];
}
-(void)initUI{
    self.title = @"我的简历";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithImage:[UIImage imageNamed:@"职位详情++"] style:UIBarButtonItemStyleDone target:self action:@selector(doAdd)];
    self.navigationItem.rightBarButtonItem = item;
    
    UIImageView *imgV = [UIImageView new];
    imgV.image = [UIImage imageNamed:@"u8419.jpg"];
    [self.view addSubview:imgV];
    [imgV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.equalTo(self.view);
        make.top.mas_offset(Size(300/2));
        make.height.mas_equalTo(Size(150));
        make.width.mas_equalTo(Size(200));
    }];
    UILabel *tipLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_153];
    tipLab.text = @"赶快去编辑属于你自己的简历吧";
    [self.view addSubview:tipLab];
    [tipLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.equalTo(imgV);
        make.top.equalTo(imgV.mas_bottom).mas_offset(Size(20));
    }];
   
    _tableV = [[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStylePlain];
    _tableV.tableFooterView = [UIView new];
    _tableV.separatorStyle = UITableViewCellSeparatorStyleNone;
    _tableV.showsVerticalScrollIndicator = NO;
    _tableV.showsHorizontalScrollIndicator = NO;
    _tableV.backgroundColor = COLOR_RGB_line;
    _tableV.dataSource = self;
    _tableV.delegate = self;
    [self.view addSubview:_tableV];
    [_tableV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    _tableV.rowHeight = Size(574/2);
    
    _tableV.mj_header = [YMRefreshHeader ym_headerWithRefreshingsBlock:^{
        _pageNum = 1;
        [self requestResumeListData];
    } animated:NO];
    _tableV.mj_footer = [YMRefreshFooter ym_footerWithRefreshingsBlock:^{
        _pageNum++;
        [self requestResumeListData];
    } animated:NO];
}

#pragma mark - request
-(void)requestResumeListData{
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:NSStringFromInteger(_pageNum) forKey:@"currPage"];
    [dataDic setValue:@"10" forKey:@"pageSize"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appToJumpMyResumeOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            MineResumeListModel *model = [MineResumeListModel mj_objectWithKeyValues:data];
            if (_pageNum == 1) {
                self.dataSource = model.data.list;
                if (self.dataSource.count == 0) {
                    self.tableV.hidden = YES;
                }else{
                    self.tableV.hidden = NO;
                }
                [self.tableV.mj_header endRefreshing];
                [self.tableV.mj_footer resetNoMoreData];
            }else{
                NSMutableArray *temp = [NSMutableArray arrayWithArray:self.dataSource];
                [temp addObjectsFromArray:model.data.list];
                self.dataSource = [temp copy];
            }
            if (model.data.isLastPage) {
                [self.tableV.mj_footer endRefreshingWithNoMoreData];
            }else{
                [self.tableV.mj_footer endRefreshing];
            }
            
            [self.tableV reloadData];
        }
        else{
            [self.tableV.mj_footer endRefreshing];
            [self.tableV.mj_header endRefreshing];
        }
    });
}
#pragma mark - action
-(void)doAdd{
    AddResumeViewController *vc = [AddResumeViewController new];
    [self.navigationController pushViewController:vc animated:YES];
}

#pragma mark - tableview delegate
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.dataSource.count;
}
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CELL_DEFINE(MineResumeTableViewCell);
    MineResumeList *list = self.dataSource[indexPath.row];
    cell.list = list;
    cell.defaultResumeBlock = ^(UIButton * _Nonnull btn) {
        if (!btn.selected) {
            NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
            [dataDic setValue:@"0" forKey:@"resumeType"];// 简历类型 0,在线简历 1.附件简历
            [dataDic setValue:@"1" forKey:@"open_type"];//1 默认  0 取消
            [dataDic setValue:NSStringFromInteger(list.ID) forKey:@"resumeId"];
            
            NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
            [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
            [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
            
            [[RHNetAPIManager sharedManager]appSetDefResumeOPT:paramDic].hiddenLoading().start(^(id data, NSString *msg, NSInteger code, NSError *error) {
                if (data) {
                    [HUD showHUDError:nil title:msg];
                    _pageNum = 1;
                    [self requestResumeListData];
                }
            });
        }
        
    };
    cell.deleteBlock = ^{
        NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
        [dataDic setValue:NSStringFromInteger(list.ID) forKey:@"resumeId"];
        
        NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
        [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
        [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
        
        [[RHNetAPIManager sharedManager]appDeleteResumeByIdOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
            if (data) {
                [HUD showHUDError:nil title:msg];
                _pageNum = 1;
                [self requestResumeListData];
            }
        });
    };
    return cell;
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    AddResumeViewController *vc = [AddResumeViewController new];
    vc.resumeId = NSStringFromInteger(self.dataSource[indexPath.row].ID);
    [self.navigationController pushViewController:vc animated:YES];
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
