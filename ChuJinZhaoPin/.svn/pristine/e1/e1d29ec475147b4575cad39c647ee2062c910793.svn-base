//
//  ProjectExperienceViewController.m
//  ChuJinZhaoPin
//
//  Created by eims on 2018/11/10.
//  Copyright © 2018 Monster. All rights reserved.
//

#import "ProjectExperienceViewController.h"
#import "YMTextView.h"
#import "YMDatePickerView.h"
#import "ProjectExperienceModel.h"
#import "YMDatePickerView.h"
@interface ProjectExperienceViewController ()<UITextFieldDelegate,UITextViewDelegate>
@property (nonatomic, strong) UITextField *projectTF;
@property (nonatomic, strong) UITextField *companyTF;
@property (nonatomic, strong) UITextField *startTF;
@property (nonatomic, strong) UITextField *endTF;
@property (nonatomic, strong) YMTextView *describeTextV;
@property (nonatomic, strong) YMTextView *dutyV;

@property (nonatomic, strong) ProjectExperienceModel *model;
@property (nonatomic, strong) ProjectExperienceData *dataSourceM;
@end

@implementation ProjectExperienceViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self initUI];
    
    if (self.projectId) {
        [self requestInitData];
    }else{
        self.dataSourceM = [[ProjectExperienceData alloc]init];
    }
    
}
-(void)initUI{
    self.title = @"项目经验";
    
    UIBarButtonItem *item = [[UIBarButtonItem alloc]initWithTitle:@"保存" style:UIBarButtonItemStyleDone target:self action:@selector(doSaveBarItem)];
    self.navigationItem.rightBarButtonItem = item;
    
    UIScrollView *scrollV = [UIScrollView new];
    [self.view addSubview:scrollV];
    [scrollV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(self.view);
    }];
    
    UIView *contentV = [UIView new];
    contentV.backgroundColor = COLOR_BG;
    [scrollV addSubview:contentV];
    [contentV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.equalTo(scrollV);
    }];
    
    UIView *line1 = [UIView new];
    line1.backgroundColor = COLOR_RGB_line;
    [contentV addSubview:line1];
    [line1 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.mas_offset(Size(10));
        make.height.mas_equalTo(0.5);
        make.width.mas_equalTo(kScreenWidth);
    }];
    
    //项目名称
    UIView *projectV = [UIView new];
    projectV.backgroundColor = RGBCOLOR(255, 255, 255);
    [contentV addSubview:projectV];
    [projectV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(line1.mas_bottom);
        make.height.mas_equalTo(Size(60));
    }];
    UILabel *projectLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    NSMutableAttributedString *attr0 = [[NSMutableAttributedString alloc]initWithString:@"*项目名称" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
    [attr0 addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
    projectLab.attributedText = attr0;
    [projectV addSubview:projectLab];
    [projectLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.centerY.equalTo(projectV);
    }];
    
    _projectTF = [UITextField new];
    _projectTF.delegate = self;
    _projectTF.font = FONT_SIZE_15;
    _projectTF.textColor = COLOR_RGB_51;
    _projectTF.textAlignment = NSTextAlignmentRight;
    _projectTF.placeholder = @"请填写";
    [projectV addSubview:_projectTF];
    [_projectTF mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_offset(-Size(15));
        make.centerY.equalTo(projectV);
        make.left.mas_lessThanOrEqualTo(projectLab.mas_right);
    }];
    
    UIView *projectL = [UIView new];
    projectL.backgroundColor = COLOR_RGB_line;
    [projectV addSubview:projectL];
    [projectL mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.right.mas_offset(-Size(15));
        make.bottom.equalTo(projectV);
        make.height.mas_equalTo(0.5);
    }];
//u所属公司
    UIView *companyV = [UIView new];
    companyV.backgroundColor = RGBCOLOR(255, 255, 255);
    [contentV addSubview:companyV];
    [companyV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(projectV.mas_bottom);
        make.height.mas_equalTo(Size(60));
    }];
    UILabel *companyLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    NSMutableAttributedString *attr = [[NSMutableAttributedString alloc]initWithString:@"*所属公司" attributes:@{NSForegroundColorAttributeName:COLOR_RGB_51}];
    [attr addAttribute:NSForegroundColorAttributeName value:COLOR_MAIN range:NSMakeRange(0, 1)];
    companyLab.attributedText = attr;
    [companyV addSubview:companyLab];
    [companyLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.centerY.equalTo(companyV);
    }];
    
    _companyTF = [UITextField new];
    _companyTF.delegate = self;
    _companyTF.font = FONT_SIZE_15;
    _companyTF.textColor = COLOR_RGB_51;
    _companyTF.textAlignment = NSTextAlignmentRight;
    _companyTF.placeholder = @"请填写";
    [companyV addSubview:_companyTF];
    [_companyTF mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_offset(-Size(15));
        make.centerY.equalTo(companyV);
        make.left.mas_lessThanOrEqualTo(companyLab.mas_right);
    }];
    
    UIView *companyL = [UIView new];
    companyL.backgroundColor = COLOR_RGB_line;
    [companyV addSubview:companyL];
    [companyL mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.right.mas_offset(-Size(15));
        make.bottom.equalTo(companyV);
        make.height.mas_equalTo(0.5);
    }];
    
    //开始时间
    UIView *startV = [UIView new];
    startV.backgroundColor = RGBCOLOR(255, 255, 255);
    [contentV addSubview:startV];
    [startV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(companyV.mas_bottom);
        make.height.mas_equalTo(Size(60));
    }];
    UILabel *startLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    startLab.text = @"开始时间";
    [startV addSubview:startLab];
    [startLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.centerY.equalTo(startV);
    }];
    
    _startTF = [UITextField new];
    _startTF.delegate = self;
    _startTF.font = FONT_SIZE_15;
    _startTF.textColor = COLOR_RGB_51;
    _startTF.placeholder = @"请选择";
    _startTF.textAlignment = NSTextAlignmentRight;
    _startTF.enabled = YES;
    [startV addSubview:_startTF];
    [_startTF mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_offset(-Size(15));
        make.centerY.equalTo(startV);
        make.left.mas_lessThanOrEqualTo(startLab.mas_right);
    }];
    
    UIView *startL = [UIView new];
    startL.backgroundColor = COLOR_RGB_line;
    [startV addSubview:startL];
    [startL mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.right.mas_offset(-Size(15));
        make.bottom.equalTo(startV);
        make.height.mas_equalTo(0.5);
    }];
    
    //结束时间
    UIView *endV = [UIView new];
    endV.backgroundColor = RGBCOLOR(255, 255, 255);
    [contentV addSubview:endV];
    [endV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(startV.mas_bottom);
        make.height.mas_equalTo(Size(60));
    }];
    UILabel *endLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    endLab.text = @"结束时间";
    [endV addSubview:endLab];
    [endLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.centerY.equalTo(endV);
    }];
    
    _endTF = [UITextField new];
    _endTF.delegate = self;
    _endTF.font = FONT_SIZE_15;
    _endTF.textColor = COLOR_RGB_51;
    _endTF.placeholder = @"请选择";
    _endTF.textAlignment = NSTextAlignmentRight;
    _endTF.enabled = YES;
    [endV addSubview:_endTF];
    [_endTF mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_offset(-Size(15));
        make.centerY.equalTo(endV);
        make.left.mas_lessThanOrEqualTo(endLab.mas_right);
    }];
    
    UIView *endL = [UIView new];
    endL.backgroundColor = COLOR_RGB_line;
    [endV addSubview:endL];
    [endL mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(0));
        make.right.mas_offset(-Size(0));
        make.bottom.equalTo(endV);
        make.height.mas_equalTo(0.5);
    }];
    
    UIView *describeV = [UIView new];
    describeV.layer.borderWidth = 0.5;
    describeV.layer.borderColor = COLOR_RGB_line.CGColor;
    describeV.backgroundColor = RGBCOLOR(255, 255, 255);
    [contentV addSubview:describeV];
    [describeV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(endV.mas_bottom).mas_offset(Size(10));
    }];
    
    UILabel *describeLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    describeLab.text = @"项目描述";
    [describeV addSubview:describeLab];
    [describeLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.top.mas_offset(Size(20));
    }];
    
    _describeTextV = [YMTextView new];
    _describeTextV.delegate = self;
    _describeTextV.textAlignment = NSTextAlignmentLeft;
    _describeTextV.placeholder = @"描述项目的具体类容及在项目中的主要工作内容";
    _describeTextV.textColor = COLOR_RGB_51;
    _describeTextV.font = FONT_SIZE_15;
    [describeV addSubview:_describeTextV];
    [_describeTextV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.right.mas_offset(-Size(15));
        make.top.equalTo(describeLab.mas_bottom).mas_offset(13);
        make.height.mas_greaterThanOrEqualTo(Size(154/2));
        make.bottom.equalTo(describeV.mas_bottom).mas_offset(-Size(10));
    }];
    
    
    UIView *dutyV = [UIView new];
    dutyV.layer.borderWidth = 0.5;
    dutyV.layer.borderColor = COLOR_RGB_line.CGColor;
    dutyV.backgroundColor = RGBCOLOR(255, 255, 255);
    [contentV addSubview:dutyV];
    [dutyV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_offset(0);
        make.top.equalTo(describeV.mas_bottom).mas_offset(Size(10));
        make.bottom.equalTo(contentV.mas_bottom).mas_offset(-Size(20));
    }];
    
    UILabel *dutyLab = [UILabel ym_labelWithFrame:CGRectZero font:FONT_SIZE_15 textColor:COLOR_RGB_51];
    dutyLab.text = @"责任描述";
    [dutyV addSubview:dutyLab];
    [dutyLab mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.top.mas_offset(Size(20));
    }];
    
    _dutyV = [YMTextView new];
    _dutyV.delegate = self;
    _dutyV.textAlignment = NSTextAlignmentLeft;
    _dutyV.placeholder = @"描述在项目中所担的责任";
    _dutyV.textColor = COLOR_RGB_51;
    _dutyV.font = FONT_SIZE_15;
    [dutyV addSubview:_dutyV];
    [_dutyV mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_offset(Size(15));
        make.right.mas_offset(-Size(15));
        make.top.equalTo(dutyLab.mas_bottom).mas_offset(13);
        make.height.mas_greaterThanOrEqualTo(Size(154/2));
        make.bottom.equalTo(dutyV.mas_bottom).mas_offset(-Size(10));
    }];
}
-(void)updateUI{
    self.projectTF.text = self.dataSourceM.proName;
    self.companyTF.text = self.dataSourceM.locCompany;
    self.startTF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.startTime/1000] stringWithFormat:@"yyyy-MM-dd"];
    self.endTF.text = [[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.endTime/1000] stringWithFormat:@"yyyy-MM-dd"];
    self.describeTextV.text = self.dataSourceM.proDescrib;
    self.dutyV.text = self.dataSourceM.responsibility;
}
#pragma mark - request
-(void)requestInitData{
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.projectId forKey:@"id"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appGetResumeProjectExperienceByIdOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            self.model = [ProjectExperienceModel mj_objectWithKeyValues:data];
            self.dataSourceM = self.model.data;
            [self updateUI];
        }
    });
}

#pragma mark - action
-(void)doSaveBarItem{
    if (self.projectTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写项目名称"];
        return;
    }
    if (self.companyTF.text.length == 0) {
        [HUD showHUDError:nil title:@"请填写公司名称"];
        return;
    }
    
    NSMutableDictionary *dataDic = [NSMutableDictionary dictionary];
    [dataDic setValue:self.dataSourceM.ID == 0 ? @"" : NSStringFromInteger(self.dataSourceM.ID) forKey:@"id"];
    
    [dataDic setValue:self.resumeId forKey:@"resumeId"];
    [dataDic setValue:self.projectTF.text forKey:@"proName"];
    [dataDic setValue:self.startTF.text forKey:@"startTime"];
    [dataDic setValue:self.endTF.text forKey:@"endTime"];
    [dataDic setValue:self.companyTF.text forKey:@"locCompany"];
    [dataDic setValue:self.describeTextV.text forKey:@"proDescrib"];
    [dataDic setValue:self.dutyV.text forKey:@"responsibility"];
    
    NSMutableDictionary *paramDic = [NSMutableDictionary dictionary];
    [paramDic setValue:[dataDic mj_JSONString] forKey:@"data"];
    [paramDic setValue:AppDelegateInstance.token forKey:@"token"];
    
    [[RHNetAPIManager sharedManager]appAddOrEditResumeProjectExperienceOPT:paramDic].start(^(id data, NSString *msg, NSInteger code, NSError *error) {
        if (data) {
            [HUD showHUDError:nil title:@"已保存"];
            BLOCK_EXEC(self.addResumeBlock,[data valueForKey:@"data"]);
            [self.navigationController popViewControllerAnimated:YES];
        }
    });
}

#pragma mark - textView/textField delegate
-(BOOL)textFieldShouldBeginEditing:(UITextField *)textField{
    if (textField == self.endTF) {
        [self.view endEditing:YES];
        YMDatePickerView *picke = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-Size(250)-kSecrityHeight width:kScreenWidth height:Size(250)+kSecrityHeight ];
        
        picke.datePickerStyle = DateStyleShowYearMonthDay;
        [picke getNowDate:[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.endTime/1000] animated:NO];
        
        picke.doneBlock = ^(NSDate *date) {
            
            self.dataSourceM.endTime = [date timeIntervalSince1970]*1000;
            self.endTF.text = [date stringWithFormat:@"yyyy-MM-dd"];
        };
        [picke show];
        
        return NO;
    }
    if (textField == self.startTF) {
        [self.view endEditing:YES];
        YMDatePickerView *picke = [[YMDatePickerView alloc]initWithUI:0 y:kScreenHeight-Size(250)-kSecrityHeight width:kScreenWidth height:Size(250)+kSecrityHeight ];
        
        picke.datePickerStyle = DateStyleShowYearMonthDay;
        [picke getNowDate:[NSDate dateWithTimeIntervalSince1970:self.dataSourceM.startTime/1000] animated:NO];
        
        picke.doneBlock = ^(NSDate *date) {
            
            self.dataSourceM.startTime = [date timeIntervalSince1970]*1000;
            self.startTF.text = [date stringWithFormat:@"yyyy-MM-dd"];
        };
        [picke show];
        
        return NO;
    }
    return YES;
}
-(void)textFieldDidEndEditing:(UITextField *)textField{
    if (textField == self.projectTF) {
        self.dataSourceM.proName = textField.text;
    }
    if (textField == self.companyTF) {
        self.dataSourceM.locCompany = textField.text;
    }
    
    
}

-(void)textViewDidEndEditing:(UITextView *)textView{
    if (textView == self.dutyV) {
        self.dataSourceM.responsibility = textView.text;
    }
    if (textView == self.describeTextV) {
        self.dataSourceM.proDescrib = textView.text;
    }
}

-(void)textViewDidChange:(UITextView *)textView{
    /*CGSize size = [textView sizeThatFits:CGSizeMake(kScreenWidth-Size(30), CGFLOAT_MAX)];
    CGFloat height = size.height;
    if (height > Size(60)) {
        if (textView == self.introTextV) {
            [self.introTextV mas_updateConstraints:^(MASConstraintMaker *make) {
                make.height.mas_equalTo(height);
            }];
        }else{
            [self.dutyV mas_updateConstraints:^(MASConstraintMaker *make) {
                make.height.mas_equalTo(height);
            }];
        }
        
    }else{
        if (textView == self.introTextV) {
            [self.introTextV mas_updateConstraints:^(MASConstraintMaker *make) {
                make.height.mas_equalTo(Size(60));
            }];
        }else{
            [self.dutyV mas_updateConstraints:^(MASConstraintMaker *make) {
                make.height.mas_equalTo(Size(60));
            }];
        }
    }*/
    
    
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
